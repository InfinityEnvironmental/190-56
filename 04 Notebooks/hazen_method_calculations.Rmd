---
title: "Hazen Method Calculations"
author: "Francois van Schalkwyk"
date: "`r Sys.Date()`"
output: word_document
---

## Set working directory for all code chunks to project root directory

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Load required packages

```{r message = FALSE}
library(tidyverse)
library(dbplyr)
library(DBI)
library(pdftools)
library(readxl)
```

## Database Connection

```{r db connection}
# Connect to the Postgres database
con <- dbConnect(RPostgres::Postgres(),
  host = "infinity.cdmqm0mu0qf8.eu-north-1.rds.amazonaws.com",
  port = 5432,
  user = rstudioapi::askForPassword(prompt = "Username: "),
  password = rstudioapi::askForPassword(),
  dbname = "infinity"
)
```

```{r}
dbGetInfo(con)
```

# Hazen Method

```{r read-coastal-data}
tbl(con, I("coastal.results_view")) |>
  collect() |>
  group_by(site_id) |>
  summarise(hazen90 = quantile(enterococci_cfu_per_100ml_numeric, probs = 0.9, type = 5))
```


```{r}
hazen_method <- function(data){
  # Summarise start and end date
  start_date <- data |>
  arrange(sample_date) |>
  slice_head(n = 1) |>
  pull(sample_date)
  
  # Summarise end date
  end_date <- data |>
  arrange(sample_date) |>
  slice_tail(n = 1) |>
  pull(sample_date)
  
  # Extract FIB data
  l <- data$enterococci_cfu_per_100ml_numeric |> sort()
  
  # Extract sample size
  n <- data$enterococci_cfu_per_100ml_numeric |> length()
  
  # Hazen method
  r_hazen95 <- 0.5 + (0.95 * n)
  rf95 <- r_hazen95 - floor(r_hazen95)
  hazen95 <- pluck(l, floor(r_hazen95)) * (1 - rf95) + pluck(l, ceiling(r_hazen95)) * rf95
  
  r_hazen90 <- 0.5 + (0.9 * n)
  rf90 <- r_hazen90 - floor(r_hazen90)
  hazen90 <- pluck(l, floor(r_hazen90)) * (1 - rf90) + pluck(l, floor(r_hazen90) + 1) * rf90
  
  # Create summary table
  summary <- tibble(start_date = start_date, end_date = end_date, sample_size = n, hazen95 = hazen95, hazen90 = hazen90) |>
  mutate(water_quality = case_when(
    sample_size < 10 ~ "Not enough samples",
    hazen95 <= 100 ~ "Excellent",
    hazen95 <= 200 ~ "Good",
    hazen95 > 200 & hazen90 > 185 ~ "Poor",
    hazen95 > 200 & hazen90 < 185 ~ "Sufficient"
  ))
}

# Call Hazen method function
data <- tbl(con, I("coastal.results_view")) |>
  collect()

# Hazen method for percentiles
percentile_hazen <- function(data, p){
  # Extract FIB data
  l <- data |> sort()
  
  # Extract sample size
  n <- data |> length()
  
  # Hazen method
  r_hazen <- 0.5 + (0.9 * n)
  rf <- r_hazen - floor(r_hazen)
  hazen <- pluck(l, floor(r_hazen)) * (1 - rf) + pluck(l, ceiling(r_hazen)) * rf
  
  return(hazen)
}

data |>
  group_by(site_id) |>
  summarise(hazen90 = percentile_hazen(enterococci_cfu_per_100ml_numeric, 0.9))

```

```{r test-hazen-method}
# Test the user-defined function
data <- read_excel("../../../Infinity/Infinity Projects - Files/190-56 Coastal WQ/02_Working Directory/01 Input Data/From CCT/Hout Bay Mariner's Wharf daily.xlsm",
           sheet = "Faecal streptococci")

hazen_method(data)

# Test the quantile function in R

l <- data |> pull(2) |> sort()

quantile(l, probs = 0.95, type = 5)
quantile(l, probs = 0.90, type = 5)

```




