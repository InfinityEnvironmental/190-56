---
title: "Hazen Method Calculations"
author: "Francois van Schalkwyk"
date: "`r Sys.Date()`"
output: word_document
---

# Workspace Set Up

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  root.dir = rprojroot::find_rstudio_root_file()
  )
```

```{r load-packages}
library(tidyverse)
library(readxl)
```

# Hazen Method

```{r read-excel-data}
hout_bay <- read_excel("../../../Infinity/Infinity Projects - Files/190-56 Coastal WQ/02_Working Directory/01 Input Data/From CCT/13_Hout_Bay_(XCN10) weekly.xlsm",
           sheet = "Faecal streptococci") |>
  rename(date = Date, faecal_streptococci_cfu_per_100ml = "Fecal Strep")
```

```{r}
hazen_method <- function(data){
  # Summarise start and end date
  start_date <- hout_bay |>
  arrange(date) |>
  slice_head(n = 1) |>
  pull(date)
  
  # Summarise end date
  end_date <- hout_bay |>
  arrange(date) |>
  slice_tail(n = 1) |>
  pull(date)
  
  # Extract FIB data
  l <- hout_bay$faecal_streptococci_cfu_per_100ml |> sort()
  
  # Extract sample size
  n <- hout_bay$faecal_streptococci_cfu_per_100ml |> length()
  
  # Hazen method
  r_hazen95 = 0.5 + (0.95 * n)
  rf95 <- r_hazen95 - floor(r_hazen95)
  hazen95 <- pluck(l, floor(r_hazen95)) * (1 - rf95) + pluck(l, floor(r_hazen95 + 1)) * rf95
  
  r_hazen90 <- 0.5 + (0.9 * n)
  rf90 <- r_hazen90 - floor(r_hazen90)
  hazen90 <- pluck(l, floor(r_hazen90)) * (1 - rf90) + pluck(l, floor(r_hazen90) + 1) * rf90
  
  # Create summary table
  tibble(start_date = start_date, end_date = end_date, sample_size = n, hazen95 = hazen95, hazen90 = hazen90) |>
  mutate(water_quality = case_when(
    sample_size < 10 ~ "Not enough samples",
    hazen95 <= 100 ~ "Excellent",
    hazen95 <= 200 ~ "Good",
    hazen95 > 200 & hazen90 > 185 ~ "Poor",
    hazen95 > 200 & hazen90 < 185 ~ "Sufficient"
  ))
}

# Call Hazen method function
hazen_method(hout_bay)
```

```{r test-hazen-method}
read_excel("../../../Infinity/Infinity Projects - Files/190-56b Ad hoc CWQ projects/")
```




