---
title: "historical_coastal_water_quality"
output: html_document
---

# Set working directory for all code chunks to project root directory

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Load required packages

```{r message = FALSE}
library(tidyverse)
library(dbplyr)
library(DBI)
library(pdftools)
library(readxl)
```
# Database Connection

```{r db connection}
# Enter credentials when prompted
con <- dbConnect(RPostgres::Postgres(),
  host = "aws-0-eu-central-1.pooler.supabase.com",
  port = 5432,
  user = str_c(rstudioapi::askForPassword(prompt = "Username: "), "wnrvdvesovnkmqbhkhjz", sep = "."),
  password = rstudioapi::askForPassword(),
  dbname = "postgres"
)
```

```{r prepare-city-colours}
city_blue <- "#0098c5"
city_green <- "#bacf00"
city_pink <- "#c8006f"
city_teal <- "#005870"
city_dark_green <- "#446414"
city_red <- "#9d2235"
city_brown <- "#47292e"
city_tan <- "#98871f"
```

```{r}
dbGetInfo(con)
```

# Data import

```{r data-import}
results <- tbl(con, I("coastal.results_view")) |> collect()
results_sorted <- results %>%
  arrange(sample_date)
view(results_sorted)

#Check frequency of sampling
results_frequency <- results %>%
  group_by(site_id, monitoring_group) %>%
  summarize(
    n_samples = n_distinct(sample_date),
    min_date = min(sample_date),
    max_date = max(sample_date)
  ) %>%
  mutate(
    date_range = as.numeric(max_date - min_date),
    frequency = ifelse(n_samples > 1, date_range / (n_samples - 1), 0) # Calculate average interval
  )
```

# Calculating routine monitoring group percentiles

## Monthly Scale

```{R Calculate monthly/yearly 90th & 95th Hazen percentile values of routine monitoring group}
# Filter routine monitoring group
routine_data <- results_sorted %>%
  filter(monitoring_group == "routine")
unique(routine_data$numeric_value)

monthly_routine <- routine_data %>%
  mutate(
    year_month = format(sample_date, "%Y-%m") 
  ) %>%
  group_by(site_id, year_month, lab_code) %>%
  summarize(
    p90_enterococci = round(quantile(numeric_value, probs = 0.90, na.rm = TRUE, type = 5), 0),
    p95_enterococci = round(quantile(numeric_value, probs = 0.95, na.rm = TRUE, type = 5), 0),
    .groups = "drop"
  )
view(monthly_routine)
```

## Yearly Scale

```{R Calculate monthly/yearly 90th & 95th Hazen percentile values of routine monitoring group}

yearly_routine <- routine_data %>%
  mutate(
    year = format(sample_date, "%Y")
  ) %>%
  group_by(site_id, year, lab_code) %>%
  summarize(
    p90_enterococci = round(quantile(numeric_value, probs = 0.90, na.rm = TRUE, type = 5), 0),
    p95_enterococci = round(quantile(numeric_value, probs = 0.95, na.rm = TRUE, type = 5), 0),
    .groups = "drop"
  )
view(yearly_routine)
```

#Plotting routine monitoring group percentiles

## Monthly Scale

```{R Plotting 90th & 95th Hazen percentiles of routine monitoring group}
#Monthly plots for each site are too cluttered, would prefer visualization on a yearly scale

library(ggplot2)

# Define colour palette for the labs
lab_colours <- c("SABS" = "red", "SSVC" = "blue", "WLAB" = "green")

unique_sites1 <- unique(monthly_routine$site_id)

for (site in unique_sites1) {
  site_data <- monthly_routine %>%
    filter(site_id == site) %>%
    pivot_longer(cols = c(p90_enterococci, p95_enterococci),
                 names_to = "percentile",
                 values_to = "enterococci_value")

  plot <- ggplot(site_data, aes(x = year_month, y = enterococci_value, group = interaction(lab_code, percentile), colour = lab_code, 
    linetype =percentile)) +
    geom_line(linewidth = 0.7)+
    geom_point() +
    scale_colour_manual(values = lab_colours) +
    scale_linetype_manual(values = c("p90_enterococci" = "solid", "p95_enterococci" = "dashed"),
                          labels = c("90th Percentile", "95th Percentile")) +
    labs(
      title = paste("Routine Monitoring Monthly Enterococci Percentiles - Site:", site),
      x = "Sampling date",
      y = "Enterococci (cfu/100ml)",
      colour = "Lab",
      linetype = "Percentile"
    ) +
    theme_minimal() +
    theme(
      axis.line = element_line(colour = "black"),
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(-0.15, "cm"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1))

  print(plot) 
}
```

## Yearly Scale

```{R Plotting 90th & 95th Hazen percentiles of routine monitoring group}

unique_sites2 <- unique(yearly_routine$site_id)

for (site in unique_sites2) {
  site_data <- yearly_routine %>%
    filter(site_id == site)%>%
    pivot_longer(cols = c(p90_enterococci, p95_enterococci),
                 names_to = "percentile",
                 values_to = "enterococci_value")

  plot <- ggplot(site_data, aes(x = year, y = enterococci_value, group = interaction(lab_code, percentile), colour = lab_code, 
    linetype =percentile)) +
    geom_line(linewidth = 0.7) +
    geom_point() +
    scale_colour_manual(values = lab_colours) +
    scale_linetype_manual(values = c("p90_enterococci" = "solid", "p95_enterococci" = "dashed"),
                          labels = c("90th Percentile", "95th Percentile")) +
    labs(
      title = paste("Routine Monitoring Yearly Enterococci Percentiles - Site:", site),
      x = "Year",
      y = "Enterococci (cfu/100ml)",
      colour = "Lab",
      linetype = "Percentile"
    ) +
    theme_minimal() +
    theme(
      axis.line = element_line(colour = "black"),
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(-0.15, "cm"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1))

  print(plot)
}
```

# Calculating daily monitoring group percentiles

## Monthly Scale

```{R Calculate 90th & 95th Hazen percentiles for daily monitoring group}
# Filter daily monitoring group
daily_monitoring <- results_sorted %>%
  filter(monitoring_group == "daily")
unique(daily_monitoring$numeric_value)

monthly_daily_monitoring <- daily_monitoring %>%
  mutate(
    year_month = format(sample_date, "%Y-%m")
  ) %>%
  group_by(site_id, year_month, lab_code) %>%
  summarize(
    p90_enterococci = round(quantile(numeric_value, probs = 0.90, na.rm = TRUE, type = 5), 0),
    p95_enterococci = round(quantile(numeric_value, probs = 0.95, na.rm = TRUE, type = 5), 0),
    .groups = "drop"
  )
view(monthly_daily_monitoring)
```

## Daily Scale

```{R Calculate 90th & 95th Hazen percentiles for daily monitoring group}

daily_percentiles_daily_mon <- daily_monitoring %>%
  group_by(site_id, sample_date, lab_code) %>%
  summarize(
    p90_enterococci = round(quantile(numeric_value, probs = 0.90, na.rm = TRUE, type = 5), 0),
    p95_enterococci = round(quantile(numeric_value, probs = 0.95, na.rm = TRUE, type = 5), 0),
    .groups = "drop"
  )
view(daily_percentiles_daily_mon)
#Don't think its necessary to plot the daily monitoring data as yearly averages because we only have 2 years worth of data

```

#Plotting daily monitoring group percentiles

## Monthly Scale

```{r Plotting 90th & 95th Hazen percentiles for daily monitoring group}
unique_sites3 <- unique(monthly_daily_monitoring$site_id)

for (site in unique_sites3) {
  site_data <- monthly_daily_monitoring %>%
    filter(site_id == site)%>%
    pivot_longer(cols = c(p90_enterococci, p95_enterococci),
                 names_to = "percentile",
                 values_to = "enterococci_value")

  plot <- ggplot(site_data, aes(x = year_month, y = enterococci_value, group = interaction(lab_code, percentile), colour = lab_code, 
    linetype = percentile)) +
    geom_line(linewidth = 0.7) +
    geom_point() +
    scale_colour_manual(values = lab_colours) +
    labs(
      title = paste("Monthly Enterococci Percentiles for daily monitoring - Site:", site),
      x = "Sampling date",
      y = "Enterococci (cfu/100ml)",
      colour = "Lab",
      linetype = "Percentile"
    ) +
    theme_minimal() +
    theme(
      axis.line = element_line(colour = "black"),
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(-0.15, "cm"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1))

  print(plot) 
}
```

## Daily Scale

```{r Plotting 90th & 95th Hazen percentiles for daily monitoring group}
#90th & 95th Percentiles are equal; only 1 unique data point for each site, for each lab, for each day

unique_sites4 <- unique(daily_percentiles_daily_mon$site_id)
library(scales) # For date formatting

for (site in unique_sites4) {
  site_data <- daily_percentiles_daily_mon %>%
    filter(site_id == site) %>%
    pivot_longer(cols = c(p90_enterococci, p95_enterococci),
                 names_to = "percentile",
                 values_to = "enterococci_value")

  plot <- ggplot(site_data, aes(x = sample_date, y = enterococci_value, group = interaction(lab_code, percentile), colour = lab_code, 
    linetype = percentile)) +
    geom_line(linewidth = 0.7) +
    geom_point() +
    scale_colour_manual(values = lab_colours) +
    scale_linetype_manual(values = c("p90_enterococci" = "solid", "p95_enterococci" = "dashed"),
                          labels = c("90th Percentile", "95th Percentile")) +
    scale_x_date(
      labels = date_format("%Y-%m-%d"),
      breaks = "2 weeks"             
    ) +
    labs(
      title = paste("Daily Enterococci Percentiles for daily monitoring - Site:", site),
      x = "Sampling date",
      y = "Enterococci (cfu/100ml)",
      colour = "Lab",
      linetype = "Percentile"
    ) +
    theme_minimal() +
    theme(
      axis.line = element_line(colour = "black"),
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(-0.15, "cm"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text.x = element_text(angle = 45, hjust = 1))

  print(plot) 
}
```

# Calculating blue flag percentiles

## Monthly Scale

```{R Calculating Blue flag 90th & 95th Hazen percentiles}
# Filter blue flag group
blue_flag <- results_sorted %>%
  filter(monitoring_group == "blue_flag")
unique(blue_flag$numeric_value)

monthly_blue_flag <- blue_flag %>%
  group_by(site_id, sample_date, lab_code) %>%
  summarize(
    p90_enterococci = round(quantile(numeric_value, probs = 0.90, na.rm = TRUE, type = 5), 0),
    p95_enterococci = round(quantile(numeric_value, probs = 0.95, na.rm = TRUE, type = 5), 0),
    .groups = "drop"
  )
view(monthly_blue_flag)
#90th & 95th Hazen percentiles  are equal; every month of blue flag data has only one data point for each month, for each site and each lab
```

## Yearly Scale

```{R Calculating Blue flag 90th & 95th Hazen percentiles}

yearly_blue_flag <- blue_flag %>%
  mutate(
    year = format(sample_date, "%Y")
  ) %>%
  group_by(site_id, year, lab_code) %>%
  summarize(
    p90_enterococci = round(quantile(numeric_value, probs = 0.90, na.rm = TRUE, type = 5), 0),
    p95_enterococci = round(quantile(numeric_value, probs = 0.95, na.rm = TRUE, type = 5), 0),
    .groups = "drop"
  )
view(yearly_blue_flag)
```

# Plotting blue flag percentiles

## Monthly Scale

```{R Plotting Blue flag 90th & 95th Hazen percentiles}
unique_sites5 <- unique(monthly_blue_flag$site_id)

for (site in unique_sites5) {
  site_data <- monthly_blue_flag %>%
    filter(site_id == site)%>%
    pivot_longer(cols = c(p90_enterococci, p95_enterococci),
                 names_to = "percentile",
                 values_to = "enterococci_value")

  plot <- ggplot(site_data, aes(x = sample_date, y = enterococci_value, group = interaction(lab_code, percentile), colour =
    lab_code,linetype = percentile)) +
    geom_line(linewidth = 0.7) +
    geom_point() +
    scale_colour_manual(values =lab_colours)+
    scale_x_date(
      labels = date_format("%Y-%m"),
      breaks = "4 months"             
    ) +
    labs(
      title = paste("Blue Flag Monthly Enterococci Percentiles - Site:", site),
      x = "Sampling date",
      y = "Enterococci (cfu/100ml)",
      colour = "Lab",
      linetype = "Percentile"
    ) +
    theme_minimal() +
    theme(axis.line = element_line(colour = "black"),
          axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(-0.15, "cm"),
           panel.grid.major = element_blank(),
           panel.grid.minor = element_blank(),
           axis.text.x = element_text(angle = 45, hjust = 1))

  print(plot) 
}
```

## Yearly Scale

```{R Plotting Blue flag 90th & 95th Hazen percentiles}

unique_sites6 <- unique(yearly_blue_flag$site_id)

for (site in unique_sites6) {
  site_data <- yearly_blue_flag %>%
    filter(site_id == site)%>%
    pivot_longer(cols = c(p90_enterococci, p95_enterococci),
                 names_to = "percentile",
                 values_to = "enterococci_value")

  plot <- ggplot(site_data, aes(x = year, y = enterococci_value, group = interaction(lab_code, percentile), colour =
    lab_code,linetype = percentile)) +
    geom_line(linewidth = 0.7) +
    geom_point() +
    scale_colour_manual(values =lab_colours)+
    labs(
      title = paste("Blue Flag Yearly Enterococci Percentiles - Site:", site),
      x = "Year",
      y = "Enterococci (cfu/100ml)",
      colour = "Lab",
      linetype = "Percentile"
    ) +
    theme_minimal() +
    theme(axis.line = element_line(colour = "black"),
          axis.ticks = element_line(colour = "black"),
          axis.ticks.length = unit(-0.15, "cm"),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.text.x = element_text(angle = 45, hjust = 1))

  print(plot) 
}
```

# Calculate the water quality category for each site for each year and plot a violin plot with the data points shown, with the violin coloured by Hazen category

1. Calculate the Hazen category for each site for each year (check with Francois, the code for the Hazen category is in Notebooks/hazen_calculation)
2. Plot a violin plot for each year (geom_violin) and colour the violins based on the water colour category (check with Francois)
3. Add the original points on top of the violin plots with alpha quite low (0.3) and the points scattered slightly (position_jitter())

```{r hazen-method}
results |>
  filter(site_id == "CN12") |>
  group_by(year = year(date)) |>
  summarise(
    min_date = min(date),
    max_date = max(date),
    nl = sum(!is.na(numeric_value_cfu_per_100ml)),
    hazen95_faecal = quantile(faecal_streptococci_cfu_per_100ml, 0.95, type = 5, na.rm = TRUE),
    hazen90_faecal = quantile(faecal_streptococci_cfu_per_100ml, 0.9, type = 5, na.rm = TRUE),
  hazen_category_faecal = case_when(
      n_faecal < 10 ~ "Not enough samples",
      hazen95_faecal <= 100 ~ "Excellent",
      hazen95_faecal <= 200 ~ "Good",
      hazen95_faecal > 200 & hazen90_faecal > 185 ~ "Poor",
      hazen95_faecal > 200 & hazen90_faecal < 185 ~ "Sufficient"
  ))
```