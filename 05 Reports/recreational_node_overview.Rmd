---
title: "Recreational Node Summary Page"
author: "Francois van Schalkwyk"
date: "`r Sys.Date()`"
output:
  bookdown::word_document2:
    reference_docx: recreational_node_overview_style_template.docx
---
# Workspace Set Up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

## Loading packages

```{r load-packages, echo = FALSE}
library(tidyverse)
library(dbplyr)
library(DBI)
library(pdftools)
library(readxl)
library(extrafont)
library(sf)
library(patchwork)
library(units)
library(osmdata)
library(ggrepel)
library(keyring)
```

## Database Connection

```{r db-connection, include=FALSE}
# Use the following code to add your credentials to the 
# key_set(service = "supabase", username = "francois")
```

```{r db-connection}
# Connect to the Postgres database
# Enter credentials when prompted
con <- dbConnect(RPostgres::Postgres(),
  host = "aws-0-eu-central-1.pooler.supabase.com",
  port = 5432,
  user = str_c(
    key_list(service = "supabase")$username,
    ".wnrvdvesovnkmqbhkhjz"
  ),
  password = key_get(
    service = "supabase",
    username = key_list(service = "supabase")$username
  ),
  dbname = "postgres"
)

dbGetInfo(con)
```

## Load the City colours

```{r prepare-city-colours}
city_blue <- "#0098c5"
city_green <- "#bacf00"
city_pink <- "#c8006f"
city_teal <- "#005870"
city_dark_green <- "#446414"
city_red <- "#9d2235"
city_brown <- "#47292e"
city_tan <- "#98871f"
```

# Data Import

## Coastal Water Quality Data

Read in the site data from our database of coastal water quality sites.

```{r read-in-site-data}
sites_sf <- st_read(con, query = "SELECT * FROM coastal.sites", as_tibble = TRUE) |>
  st_cast("POINT") |>
  filter(active) |>
  arrange(site_description)
```

```{r read-in-results-data}
sites <- tbl(con, I("coastal.sites_view"))
results <- tbl(con, I("coastal.results_view"))
```

## Open Street Map data

```{r create-bounding-box}
# Create bounding box for City of Cape Town area
cct_sites_bbox <- st_bbox(obj = c(xmin = 18.25, xmax = 18.9, ymin = -34.40, ymax = -33.5))
```

```{r coastline-data}
# Access entire coastline
cct_coastline <- opq(cct_sites_bbox) |>
  add_osm_feature("natural", "coastline") |>
  osmdata_sf()
```

Select a site to work with and then access the Open Street Map spatial data using the OSM package.

```{r check-sites}
site_id <- sites |>
  filter(active, category == "Recreational Node") |>
  pull(site_id) # 73 sites
```

```{r choose-site}
site_code <- site_id |> keep_at(73)
width <- 1500
```

```{r create-bounding-box-for-site}
create_bounding_box_wgs <- function(site_code) {
  # Create a bounding box for one site
  site_bbox <- sites_sf |>
    filter(site_id == site_code) |>
    st_bbox() + c(-0.015, -0.012, 0.015, 0.012)
  return(site_bbox)
}
site_bbox <- create_bounding_box_wgs(site_code)

create_bounding_box_htb <- function(site_code, width) {
  # Transform bounding box to 102562
  bbox_htb <- sites_sf |>
    filter(site_id == site_code) |>
    st_transform(crs = "ESRI: 102562") |>
    st_bbox() + c(-width, -width, width, width)
  return(bbox_htb)
}
bbox_htb <- create_bounding_box_htb(site_code, width)
```

```{r}
# Access coastline data for specific site
coastline <- opq(site_bbox) |>
  add_osm_feature("natural", "coastline") |>
  osmdata_sf()

# Access beach data
beaches <- opq(site_bbox) |>
  add_osm_feature("natural", "beach") |>
  osmdata_sf()

# Access street data from OSM
streets <- opq(site_bbox) |>
  add_osm_feature(key = "highway") |>
  osmdata_sf()

# Access buildings data
buildings <- opq(site_bbox) |>
  add_osm_feature(key = "building") |>
  osmdata_sf()

# Access water
water <- opq(site_bbox) |>
   add_osm_feature("natural", "water") |>
   osmdata_sf()

# Add rivers
river <- opq(site_bbox) |>
   add_osm_feature("waterway", c("river", "stream")) |>
   osmdata_sf()

# Add train
rail <- opq(site_bbox) |>
  add_osm_feature("type", "route") |>
  osmdata_sf()

# Add reservoir
reservoir <- opq(site_bbox) |>
  add_osm_feature("landuse", "reservoir") |>
  osmdata_sf()
```

# Data Visualisation

## Entire Coastline

```{r coastline-overview, fig.width = 3.5, fig.height = 3.5, dpi = 600}
# Plot overview of entire coastline
site_overview <- ggplot() +
  geom_sf(data = cct_coastline$osm_lines, colour = "white", linewidth = 0.4) +
  geom_sf(data = sites_sf, aes(colour = category, size = category), shape = 16) +
  geom_sf(data = sites_sf |> filter(site_id == site_code), colour = city_pink, size = unit(4, "mm"), alpha = 0.5, shape = 16) +
   geom_sf(data = bbox_htb |> st_as_sfc(), colour = "white", fill = NA) +
  
  # Plot styling
  theme(
      legend.position = "inside",
      legend.position.inside = c(0.35, 0.1),
      legend.justification = "left",
      legend.text = element_text(size = 8, colour = "white"),
      legend.background = element_blank(),
      axis.ticks = element_blank(),
      axis.text = element_blank(),
      plot.background = element_blank(),
      panel.background = element_blank(),
      text = element_text(family = "Century Gothic"),
      legend.title = element_blank(),
      plot.title = element_text(hjust = 0.5),
      plot.subtitle = element_text(hjust = 0.5),
      panel.grid = element_blank()
    ) +
  scale_colour_manual(values = c("Recreational Node" = city_green, "Coastal Monitoring Point" = "lightgrey")) +
  scale_size_manual(values = c("Recreational Node" = unit(2, "mm"), "Coastal Monitoring Point" = unit(1, "mm")))
```

## Site Map

```{r plot-map, fig.width = 3.5, fig.height = 3.5, dpi = 600}
# Plot all data for a specific site
(site_map <- ggplot() +
  
  # Add beaches
  geom_sf(data = beaches$osm_polygons |> st_transform("ESRI: 102562"), fill = "lightyellow", colour = NA, alpha = 0.5) +
  # geom_sf(data = beaches$osm_multipolygons |> st_transform("ESRI: 102562"), fill = "lightyellow", colour = NA, alpha = 0.5) +
  
  # Add rivers
  geom_sf(data = river$osm_lines |> st_transform("ESRI: 102562"), colour = "lightblue", alpha = 0.7) +
  geom_sf(data = river$osm_polygons |> st_transform("ESRI: 102562"), colour = "lightblue", alpha = 0.7) +
  # geom_sf(data = river$osm_multilines |> st_transform("ESRI: 102562"), colour = "lightblue", alpha = 0.7) +
  
  # Add other water
  geom_sf(data = water$osm_polygons |> st_transform("ESRI: 102562"), fill = "lightblue", alpha = 0.7, colour = NA) +
  # geom_sf(data = water$osm_multipolygons |> st_transform("ESRI: 102562"), fill = "lightblue", alpha = 0.7, colour = NA) +
  
  # Add the coastline
  geom_sf(data = coastline$osm_lines |> st_transform("ESRI: 102562"), colour = "lightgrey", size = unit(1, "mm")) +
  geom_sf(data = coastline$osm_polygons |> st_transform("ESRI: 102562"), colour = NA, fill = "grey", alpha = 0.5) +
   
  # Add train line
  geom_sf(data = rail$osm_lines |> st_transform("ESRI: 102562"), colour = "white", linetype = "dashed", linewidth = unit(0.1, "mm")) +
   
  # Add reservoir
  geom_sf(data = reservoir$osm_polygons |> st_transform("ESRI: 102562"), fill = "lightblue", alpha = 0.7, colour = NA) +
  
  # Add streets
  geom_sf(data = streets$osm_lines |>
            st_transform("ESRI: 102562") |>
            filter(highway %in% c("motorway",
                                  "motorway_link",
                                  "trunk",
                                  "trunk_link",
                                  "primary",
                                  "primary_link",
                                  "secondary",
                                  "secondary_link",
                                  "tertiary",
                                  "tertiary_link",
                                  "unclassified",
                                  "residential",
                                  "service")),
          aes(linewidth = highway),
          colour = "lightgrey") +
   
   scale_linewidth_manual(values = c(
    "motorway" = unit(0.5, "mm"),
    "motorway_link" = unit(0.5, "mm"),
    "trunk" = unit(0.5, "mm"),
    "trunk_link" = unit(0.5, "mm"),
    "primary" = unit(0.3, "mm"),
    "primary_link" = unit(0.3, "mm"),
    "secondary" = unit(0.2, "mm"),
    "secondary_link" = unit(0.2, "mm"),
    "tertiary" = unit(0.1, "mm"),
    "tertiary_link" = unit(0.1, "mm"),
    "unclassified" = unit(0.1, "mm"),
    "residential" = unit(0.1, "mm"),
    "service" = unit(0.1, "mm")
  )) +
   # geom_sf(data = streets$osm_polygons) +
   
  # Add buildings
  geom_sf(data = buildings$osm_polygons |>
            st_transform("ESRI: 102562"), fill = "lightgrey", colour = NA, alpha = 0.5) +
   
  # Add the monitoring sites with labels
  geom_sf(data = sites_sf |> st_transform("ESRI: 102562"), aes(colour = category), size = 1) +
  geom_label_repel(data = sites_sf |> filter(category == "Recreational Node"), aes(label = str_wrap(site_description, 20), geometry = geom), stat = "sf_coordinates",
  # geom_label_repel(data = sites_sf |> filter(category == "Recreational Node"), aes(label = str_wrap(site_description, 16), geometry = geom), stat = "sf_coordinates",
            colour = "white",
            size = unit(3, "mm"),
            nudge_x = 180,
            family = "Century Gothic",
            label.padding = 0.20,
            # point.padding = 5,
            # hjust = 0,
            # force = 0.5,
            fill = city_teal,
            label.size = NA,
            # min.segment.length = 2,
            # force_pull = 120,
            xlim = c(bbox_htb[1] - 5000, bbox_htb[3] + 5000),
            ylim = c(bbox_htb[2] - 5000, bbox_htb[4] + 5000)
            ) +
   
  # Add the current monitoring point
  geom_sf(data = sites_sf |> filter(site_id == site_code) |> st_transform("ESRI: 102562"), colour = city_pink, size = 3, shape = 16) +
  
  scale_colour_manual(values = c("Recreational Node" = city_green, "Coastal Monitoring Point" = "grey")) +
  coord_sf(xlim = c(bbox_htb[1], bbox_htb[3]), ylim = c(bbox_htb[2], bbox_htb[4])) +
  
  theme(
    # plot.background = element_blank(),
    plot.background = element_rect(fill = city_teal),
    panel.background = element_blank(),
    legend.position = "inside",
    legend.position.inside = c(unit(10, "mm"), unit(10, "mm")),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    text = element_text(family = "Century Gothic")
  ))
```

## Percentage Exceedance

```{r perc-exceedance-plot}
# Join the tables
exceedances <- sites |>
  inner_join(results, by = "site_id") |>
  filter(site_id == site_code, between(sample_date, "2023-10-01", "2025-05-31"), monitoring_group %in% c("routine", "daily")) |>
  collect() |>
  summarise(
    all_samples = n(),
    samples_exceed = sum(numeric_value > 240),
    samples_exceed_pct = round(sum(numeric_value > 240) / n() * 100, 0)
  ) |>
  mutate(
    label = str_c(samples_exceed, " out of ", all_samples, " samples", sep = ""),
    extra_text = " taken exceeded the\nthreshold value for\nEnterococci of\n240 cfu per 100 mL"
  )

# Winter and summer data
seasonal_exceedances <- sites |>
  inner_join(results, by = "site_id") |>
  filter(site_id == site_code, between(sample_date, "2023-10-01", "2025-05-31"), monitoring_group %in% c("routine", "daily")) |>
  collect() |>
  mutate(season = if_else(month(sample_date) %in% c(10, 11, 12, 1, 2, 3), "Summer", "Winter")) |>
group_by(season) |>
  summarise(
    all_samples = n(),
    samples_exceed = sum(numeric_value > 240),
    samples_exceed_pct = round(sum(numeric_value > 240) / n() * 100, 0)
  ) |>
  mutate(
    label = str_c(samples_exceed, " out of ", all_samples, " samples taken\nexceeded the threshold\nvalue for Enterococci\nof 240 cfu per 100 mL", sep = "")
    )
```

```{r seasonal-exceedances}
# Winter and summer data
seasonal_exceedances <- sites |>
  inner_join(results, by = "site_id") |>
  filter(site_id == site_code, between(sample_date, "2023-10-01", "2025-05-31"), monitoring_group %in% c("routine", "daily")) |>
  collect() |>
  mutate(season = if_else(month(sample_date) %in% c(10, 11, 12, 1, 2, 3), "Summer", "Winter")) |>
group_by(season) |>
  summarise(
    all_samples = n(),
    samples_exceed = sum(numeric_value > 240),
    samples_exceed_pct = round(sum(numeric_value > 240) / n() * 100, 0)
  ) |>
  mutate(
    label = str_c(samples_exceed, " out of ", all_samples, " samples taken\nexceeded the threshold\nvalue for Enterococci\nof 240 cfu per 100 mL", sep = "")
    )
```

```{r exceedances-figure, fig.width = 6, fig.height = 3, dpi = 600}
# Create a figure for the percentage exceedances
exceed_text <- ggplot(data = exceedances) +
  geom_text(aes(x = 0, y = 0, label = label), family = "Century Gothic", size = 4, colour = "white", lineheight = 1, vjust = -0.1, fontface = "bold") +
  geom_text(aes(x = 0, y = 0, label = extra_text), family = "Century Gothic", size = 4, colour = "white", lineheight = 1, vjust = 1.1) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    legend.position = "none",
    plot.background = element_blank()
  )
```

```{r create-donut-plot, fig.width = 4, fig.height = 2, dpi = 600}
# Create progress wheel for exceedances
wheel <- exceedances |>
  ggplot(aes(x = "Site", y = samples_exceed_pct, fill = samples_exceed_pct)) +
  geom_col() + scale_fill_gradientn(colours = c("#66BD63", "#FEE08B", "#FDAE61", "#F46D43", "#D73027", "#A50026"), limits = c(0, 100), breaks = c(0, 10, 20, 50, 75, 100)) +
  coord_radial(theta = "y", start = 0, end = 2 * pi, inner.radius = 0.5, expand = FALSE) +
  facet_grid(cols = vars("All Seasons")) +
  scale_y_continuous(limits = c(0, 100)) +
  theme(
    plot.background = element_blank(),
    # plot.background = element_rect(fill = city_teal),
    legend.position = "none",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(colour = "white", family = "Century Gothic")
  )

# Create the text
text <- exceedances |>
  ggplot() + 
  geom_text(aes(x = 0, y = 0, label = str_c(samples_exceed_pct, "%", sep = "")), colour = "white", size = 6, family = "Century Gothic") +
  theme(
    plot.background = element_blank(),
    # plot.background = element_rect(fill = city_teal),
    legend.position = "none",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_blank()
  )
```

```{r create-seasonal-progress-wheel}
# Get colours from Rcolobrewer
wheel_seasonal <- seasonal_exceedances |>
  ggplot(aes(x = "Site", y = samples_exceed_pct, fill = samples_exceed_pct)) +
    geom_col() + scale_fill_gradientn(colours = c("#66BD63", "#FEE08B", "#FDAE61", "#F46D43", "#D73027", "#A50026"), limits = c(0, 100), breaks = c(0, 10, 20, 50, 75, 100)) +
    coord_radial(theta = "y", start = 0, end = 2 * pi, inner.radius = 0.5, expand = FALSE) +
  facet_grid(cols = vars(season), switch = "x") +
    scale_y_continuous(limits = c(0, 100)) +
    theme(
      plot.background = element_blank(),
      # plot.background = element_rect(fill = city_teal),
      legend.position = "none",
      axis.ticks = element_blank(),
      axis.text = element_blank(),
      axis.title = element_blank(),
      panel.grid = element_blank(),
      strip.background = element_blank(),
      strip.text = element_text(family = "Century Gothic", colour = "white", vjust = 2),
      strip.placement = "inside"
    )

text_seasonal <- seasonal_exceedances |>
  ggplot() + 
  geom_text(aes(x = 0, y = 0, label = str_c(samples_exceed_pct, "%", sep = "")), colour = "white", size = unit(4.6, "mm"), family = "Century Gothic") +
  facet_grid(cols = vars(season)) +
  theme(
    plot.background = element_blank(),
    # plot.background = element_rect(fill = city_teal),
    legend.position = "none",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_blank()
  )
```

## Hazen Categories

```{r hazen-categories, fig.width = 4, fig.height = 2.5, dpi = 600}
# Get the Hazen categories for all data
all <- sites |>
  inner_join(results, by = "site_id") |>
  filter(site_id == site_code,
         between(sample_date, "2023-10-01", "2025-05-31"),
         monitoring_group %in% c("routine", "daily")) |>
  collect() |>
  summarise(
    min_date = min(sample_date),
    max_date = max(sample_date),
    n = sum(!is.na(numeric_value)),
    hazen95 = quantile(numeric_value, 0.95, type = 5, na.rm = TRUE),
    hazen90 = quantile(numeric_value, 0.9, type = 5, na.rm = TRUE),
  hazen_category = case_when(
      n < 10 ~ "TFD*",
      hazen95 <= 100 ~ "Excellent",
      hazen95 <= 200 ~ "Good",
      hazen95 > 200 & hazen90 > 185 ~ "Poor",
      hazen95 > 200 & hazen90 < 185 ~ "Sufficient"
  )) |>
  mutate(season = "all")

# Summer data
summer <- sites |>
  inner_join(results, by = "site_id") |>
  filter(
    site_id == site_code,
    month(sample_date) %in% c(1, 2, 3, 10, 11, 12),
    between(sample_date, "2023-10-01", "2025-05-31"),
    monitoring_group %in% c("routine", "daily")) |>
  collect() |>
  summarise(
    min_date = min(sample_date),
    max_date = max(sample_date),
    n = sum(!is.na(numeric_value)),
    hazen95 = quantile(numeric_value, 0.95, type = 5, na.rm = TRUE),
    hazen90 = quantile(numeric_value, 0.9, type = 5, na.rm = TRUE),
  hazen_category = case_when(
      n < 10 ~ "TFD*",
      hazen95 <= 100 ~ "Excellent",
      hazen95 <= 200 ~ "Good",
      hazen95 > 200 & hazen90 > 185 ~ "Poor",
      hazen95 > 200 & hazen90 < 185 ~ "Sufficient"
  )) |>
  mutate(season = "summer")

# Winter data
winter <- sites |>
  inner_join(results, by = "site_id") |>
  filter(
    site_id == site_code,
    month(sample_date) %in% c(4, 5, 6, 7, 8, 9),
    between(sample_date, "2023-10-01", "2025-05-31"),
    monitoring_group %in% c("routine", "daily")) |>
  collect() |>
  summarise(
    min_date = min(sample_date),
    max_date = max(sample_date),
    n = sum(!is.na(numeric_value)),
    hazen95 = quantile(numeric_value, 0.95, type = 5, na.rm = TRUE),
    hazen90 = quantile(numeric_value, 0.9, type = 5, na.rm = TRUE),
  hazen_category = case_when(
      n < 10 ~ "TFD*",
      hazen95 <= 100 ~ "Excellent",
      hazen95 <= 200 ~ "Good",
      hazen95 > 200 & hazen90 > 185 ~ "Poor",
      hazen95 > 200 & hazen90 < 185 ~ "Sufficient"
  )) |>
  mutate(season = "winter")

# Combine the three categories

hazen_categories <- bind_rows(all, summer, winter) |>
  mutate(hazen_category = fct(hazen_category, levels = c("TFD*", "Poor", "Sufficient", "Good", "Excellent"))) |>
  complete(hazen_category, season) |>
  mutate(alpha_value = if_else(!is.na(n), 100, 50)) |>
  dplyr::select(hazen_category, season, alpha_value) |>
  ggplot() +
  labs(caption = "* Too Few Data: More samples needed to calculate water quality category using the Hazen method") +
  geom_tile(aes(x = hazen_category, y = "Season", fill = hazen_category, alpha = alpha_value, colour = as.character(alpha_value)), height = 0.8, width = 0.9, linewidth = unit(1, "mm")) +
  geom_text(aes(x = hazen_category, y = "Season", label = hazen_category), family = "Century Gothic", colour = "white", size = unit(5, "mm"), fontface = "bold") +
  scale_fill_manual(name = "Hazen Water Quality Category", values = c("TFD*" = "grey", "Poor" = "#D73027", "Sufficient" = "#FECC5C", "Good" = "#A6D96A", "Excellent" = "#3288BD")) +
  scale_colour_manual(values = c("50" = city_teal, "100" = "white")) +
  facet_grid(rows = vars(str_to_title(season)), switch = "y") +
  
# Style components
  theme(
    plot.background = element_blank(),
    plot.caption = element_text(family = "Century Gothic", colour = "white"),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "white", fill = NA, linewidth = unit(0.5, "mm")),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    legend.position = "none",
    strip.background = element_rect(fill = city_blue),
    strip.text = element_text(colour = "white", family = "Century Gothic", size = unit(10, "mm"), face = "bold")
  )
```

## Sample frequency plots

```{r sample-frequency-plot, fig.width = 8.3, fig.height = 2.5, dpi = 600}
# Create a dot plot to show the information more simply
dotplot_data <- sites |>
  inner_join(results, by = "site_id") |>
  filter(between(sample_date, "2023-10-01", "2025-05-31"), monitoring_group %in% c("routine", "daily"), site_id == site_code) |>
  collect() |>
  mutate(
    monitoring_group = str_to_title(monitoring_group),
    year = year(sample_date),
    month_day = format(sample_date, "2025-%m-%d") |> ymd())

# Create a function that takes only the first letter of the text
first_letter <- function(x){
  return(str_sub(format(x, "%b"), 1, 1))
}

# Plot the data
dotplot <- ggplot(data = dotplot_data, aes(x = month_day, fill = monitoring_group)) +
    labs(title = "Samples Collected") +
  geom_dotplot(
    colour = NA,
    method = "histodot",
    stackgroups = TRUE,
    dotsize = 0.9,
    stackratio = 1.1
  ) +
  scale_fill_manual(values = c("Routine" = city_green, "Daily" = city_blue)) +
  scale_x_date(date_breaks = "1 month", labels = first_letter) +
  scale_y_continuous(NULL, breaks = NULL) +
    facet_wrap(~year, ncol = 3, scales = "free_y", strip.position = "bottom") +
  theme(
    plot.title = element_text(colour = "white", hjust = 0.5, face = "bold", vjust = -5),
    plot.background = element_blank(),
    # plot.background = element_rect(fill = city_teal),
    legend.position = "inside",
    legend.position.inside = c(0.1, 0.9),
    legend.title = element_blank(),
    legend.background = element_blank(),
    legend.text = element_text(colour = "white", size = unit(8, "mm")),
    text = element_text(family = "Century Gothic", size = 6),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_text(colour = "white", vjust = 0.5, size = unit(6, "mm")),
    axis.text.y = element_text(colour = "white"),
    axis.ticks = element_line(colour = "white"),
    panel.background = element_blank(),
    panel.grid = element_blank(),
    plot.caption = element_text(colour = "white", size = 5),
    strip.background = element_blank(),
    strip.text = element_text(colour = "white", size = unit(6, "mm")),
    strip.placement = "outside"
  )
```

## Results

```{r results-plot}
# Plot the actual results for the period
results_plot <- sites |>
  inner_join(results, by = "site_id") |>
  filter(between(sample_date, "2023-10-01", "2025-05-31"), monitoring_group %in% c("routine", "daily")) |>
  collect() |>
  filter(site_id == site_code) |>
   mutate(
     year = year(sample_date),
     month_day = format(sample_date, "2025-%m-%d") |> ymd()
   ) |>
  ggplot(aes(x = month_day, colour = monitoring_group)) +
  labs(y = "Enterococci (cfu per 100 mL)", caption = "Dashed line shows safe threshold\nfor recreational water use (240 cfu per 100 mL)") +
  # geom_segment(aes(xend = sample_date, y = 0, yend = numeric_value)) +
  # geom_point(aes(y = numeric_value)) +
  geom_line(aes(y = numeric_value), linewidth = unit(0.7, "mm")) +
  # geom_col(aes(y = numeric_value), colour = NA) +
  geom_hline(yintercept = 240, colour = "white", linewidth = 0.5, linetype = 2) +
  facet_wrap(~year, nrow = 3) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b", limits = c(ymd("2025-01-01"), ymd("2025-12-31"))) +
  
  # Scales
  scale_colour_manual(values = c("routine" = city_green, "daily" = city_blue)) +
  
  # Theme
  theme(
    plot.title = element_text(colour = "white", hjust = 0, face = "bold"),
    plot.caption = element_text(colour = "white", hjust = 0.5, size = unit(8, "mm")),
    # plot.background = element_rect(fill = city_teal),
    plot.background = element_blank(),
    legend.position = "none",
    # legend.title = element_blank(),
    # legend.background = element_blank(),
    # legend.text = element_text(colour = "white"),
    text = element_text(family = "Century Gothic"),
    axis.title.y = element_text(colour = "white"),
    axis.title.x = element_blank(),
    axis.text.x = element_text(colour = "white", angle = 90),
    axis.text.y = element_text(colour = "white"),
    axis.ticks = element_line(colour = "white"),
    panel.background = element_blank(),
    panel.grid = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(colour = "white", size = unit(9, "mm"), face = "bold"),
    panel.border = element_rect(colour = "white", fill = NA)
  )
```

## Titles

```{r title-figure}
coast <- sites |>
  filter(site_id == site_code) |>
  mutate(coast_label = str_c(coastline, " Coast", sep = "")) |>
  ggplot() +
  geom_text(aes(x = 0, y = 1, label = coast_label), angle = 90, size.unit = "mm", size = unit(8, "mm"), family = "Century Gothic", colour = "white", fontface = "bold") +
  
  # Styles
  theme(
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  )
```

```{r site-name}
# Prepare the site name
site_name <- sites |>
  filter(site_id == site_code) |>
  mutate(coast_label = str_c(coastline, " Coast", sep = "")) |>
  ggplot() +
  geom_text(aes(x = 0, y = 1, label = site_description), angle = 90, size.unit = "mm", size = unit(8, "mm"), family = "Century Gothic", colour = "white", lineheight = 0.7) +
  
  # Styles
  theme(
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = city_blue)
  )
```

## Final Figure

```{r base-plot}
# Create the base plot
base <- ggplot() +
  theme(
    plot.background = element_rect(fill = city_teal),
    panel.background = element_blank()
    )
```

```{r add-annotations}
# Add comment about reporting period
reporting_period <- ggplot() +
  annotate(geom = "text", x = 0, y = 0, label = "Data only shown for reporting period (October 2023 to May 2025)", family = "Century Gothic", colour = "white", size = unit(3, "mm")) +
  theme(
    plot.background = element_blank(),
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )

# Add title for percentage exceedances
sample_threshold_title <- ggplot() +
  annotate(geom = "text", x = 0, y = 0, label = "Samples that exceeded threshold\nfor safe water use", family = "Century Gothic", colour = "white", size = unit(4, "mm"), fontface = "bold") +
  theme(
    plot.background = element_blank(),
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank()
  )
```

```{r assemble-plot, fig.width = 8.27, fig.height = 11.69, dpi = 600}
(infographic <- base +
  inset_element(site_overview, left = unit(100, "mm"), bottom = unit(30, "mm"), right = unit(220, "mm"), top = unit(240, "mm"), align_to = "full") +
  inset_element(coast, left = unit(0, "mm"), bottom = unit(3, "mm"), right = unit(17, "mm"), top = unit(70, "mm"), align_to = "full") +
  inset_element(site_name, left = unit(0, "mm"), bottom = unit(70, "mm"), right = unit(17, "mm"), top = unit(290, "mm"), align_to = "full") +
  inset_element(dotplot, left = unit(25+70+20, "mm"), bottom = unit(0+5, "mm"), right = unit(130+70, "mm"), top = unit(45+5, "mm"), align_to = "full") +
  inset_element(site_map, left = unit(16.5, "mm"), bottom = unit(105, "mm"), right = unit(105+5+4, "mm"), top = unit(200, "mm"), align_to = "full") +
  inset_element(results_plot, left = unit(23, "mm"), bottom = unit(47-30-5, "mm"), right = unit(105, "mm"), top = unit(120-10-5, "mm"), align_to = "full") +
  inset_element(hazen_categories, left = unit(15, "mm"), bottom = unit(200, "mm"), right = unit(200, "mm"), top = unit(290, "mm"), align_to = "full") +
  inset_element(wheel, left = unit(120+5, "mm"), bottom = unit(145-10, "mm"), right = unit(210+2+5, "mm"), top = unit(175+10, "mm")) +
  inset_element(text, left = unit(120+5, "mm"), bottom = unit(100-5-5-3+20+20, "mm"), right = unit(210+2+5, "mm"), top = unit(145-5-3+20+10+20, "mm")) +
  inset_element(exceed_text, left = unit(118+5-2, "mm"), bottom = unit(30+20+5+5, "mm"), right = unit(208+5-2, "mm"), top = unit(60 + 10 +20+20, "mm")) +
  inset_element(wheel_seasonal, left = unit(125-1-10+1+5, "mm"), bottom = unit(70+2+40, "mm"), right = unit(205+1+10+1+5, "mm"), top = unit(110-5+5-5+2+40, "mm")) +
  inset_element(text_seasonal, left = unit(132+1+4+5, "mm"), bottom = unit(77+1-3+2+40, "mm"), right = unit(198+1-4+5, "mm"), top = unit(107+1-3+2+40, "mm")) +
  inset_element(sample_threshold_title, left = unit(132, "mm"), bottom = unit(182, "mm"), right = unit(202, "mm"), top = unit(199, "mm")) +
  inset_element(reporting_period, left = unit(100, "mm"), bottom = unit(0, "mm"), right = unit(210, "mm"), top = unit(8, "mm"), align_to = "full"))
```

```{r save-figure}
site_code
# ggsave(str_c(site_code, ".jpg", sep = ""), plot = infographic, path = "../../Infinity/Coastal Water Quality - Documents/KYC 2025/Draft Recreational Node Overviews/", width = 210, height = 297, units = "mm", dpi = 600)
ggsave(str_c(site_code, ".jpg", sep = ""), plot = infographic, path = "../../Infinity/Coastal Water Quality - Documents/KYC 2025/Draft Recreational Node Overviews/", width = 210, height = 297, units = "mm", dpi = 600)
```

## Coastline Overview

### Atlantic Coastline

```{r atlantic-coast, fig.width = 8.27, fig.height = 11.69, dpi = 600}
# Calculate percentage exceedances
all_sites_exceedances <- sites |>
  inner_join(results, by = "site_id") |>
  filter(between(sample_date, "2023-10-01", "2025-05-31"), monitoring_group %in% c("routine", "daily"), category == "Recreational Node") |>
  collect() |>
  group_by(site_id) |>
  summarise(
    all_samples = n(),
    samples_exceed = sum(numeric_value > 240),
    samples_exceed_pct = round(sum(numeric_value > 240) / n() * 100, 0)
  )

# Calculate Hazen percentages
all_sites_hazen <- sites |>
  inner_join(results, by = "site_id") |>
  filter(
         between(sample_date, "2023-10-01", "2025-05-31"),
         monitoring_group %in% c("routine", "daily"),
         category == "Recreational Node") |>
  collect() |>
  group_by(site_id) |>
  summarise(
    min_date = min(sample_date),
    max_date = max(sample_date),
    n = sum(!is.na(numeric_value)),
    hazen95 = quantile(numeric_value, 0.95, type = 5, na.rm = TRUE),
    hazen90 = quantile(numeric_value, 0.9, type = 5, na.rm = TRUE),
  hazen_category = case_when(
      n < 10 ~ "TFD*",
      hazen95 <= 100 ~ "Excellent",
      hazen95 <= 200 ~ "Good",
      hazen95 > 200 & hazen90 > 185 ~ "Poor",
      hazen95 > 200 & hazen90 < 185 ~ "Sufficient"
  ))

# Join these on site id
entire_coast_summary <- sites_sf |>
  inner_join(all_sites_hazen, by = "site_id") |>
  inner_join(all_sites_exceedances, by = "site_id") |>
  mutate(hazen_category = fct(hazen_category, levels = c("TFD", "Poor", "Sufficient", "Good", "Excellent")))
```

```{r plot-atlantic, fig.width = 8.27, fig.height = 11.69, dpi = 600}
# Plot the data
(atlantic <- ggplot() +
  geom_sf(data = cct_coastline$osm_lines, colour = "white") +
  geom_sf(data = entire_coast_summary |> filter(coastline == "Atlantic"), aes(colour = fct_rev(hazen_category)), size = 2) +
   labs(caption = "Data shown for reporting period (October 2023 to May 2025)") +
    
  # Add labels to some sites
  geom_text_repel(
      data = entire_coast_summary |> filter(coastline == "Atlantic", site_id %in% c("XCN08", "XCN12", "XCN07", "XCN02", "XCN04", "CS40", "XCN11")),
      aes(geometry = geom, label = site_description),
      stat = "sf_coordinates",
      size = unit(3, "mm"),
      xlim = c(17.9, 19.0),
      ylim = c(-34.6, -33.5),
      force = 100,
      hjust = 1,
      nudge_x = -0.14,
      colour = "white",
      family = "Century Gothic"
      ) +
  coord_sf(xlim = c(17.57, 18.45)) +

  scale_colour_manual(name = "Water Quality Category", values = c("TFD" = "grey", "Poor" = "#D73027", "Sufficient" = "#FECC5C", "Good" = "#A6D96A", "Excellent" = "#3288BD")) +
  theme(
    plot.background = element_rect(fill = city_teal, colour = NA),
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "bottom",
    legend.title.position = "left",
    legend.direction = "horizontal",
    legend.title = element_text(hjust = 0.5),
    text = element_text(family = "Century Gothic", colour = "white"),
    legend.background = element_blank()
        ) +
  guides(size = guide_legend(override.aes = list(colour = "white"))))

# Zoom in on town
(subplot <- ggplot() +
  geom_sf(data = cct_coastline$osm_lines, colour = "white") +
  geom_sf(data = entire_coast_summary |> filter(coastline == "Atlantic"), aes(colour = fct_rev(hazen_category)), size = 2) +
    geom_text_repel(
      data = entire_coast_summary |> filter(coastline == "Atlantic", site_id %in% c("CN22", "CN36", "CN39", "XCN09", "HB13", "CN42", "XCN03", "CN16O", "CN14")),
      aes(geometry = geom, label = site_description),
      stat = "sf_coordinates",
      size = unit(3, "mm"),
      xlim = c(18, 19.0),
      ylim = c(-34.3, -33.5),
      force = 100,
      hjust = 1,
      nudge_x = -0.04,
      colour = "white",
      family = "Century Gothic"
      ) +
  coord_sf(xlim = c(18.2, 18.5), ylim = c(-34.07, -33.87)) +
  
  scale_colour_manual(name = "Hazen Water Quality Category", values = c("TFD" = "grey", "Poor" = "#D73027", "Sufficient" = "#FECC5C", "Good" = "#A6D96A", "Excellent" = "#3288BD")) +
  theme(
    plot.background = element_rect(fill = NA, colour = "white"),
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    legend.position = "none",
    text = element_text(family = "Century Gothic", colour = "white")
        ))

# Coastline title
atlantic_title <- ggplot() +
    geom_text(aes(x = 0, y = 1, label = "Atlantic Coast"), hjust = 1, size = unit(12, "mm"), family = "Century Gothic", colour = "white", fontface = "bold") +
  
  # Styles
  theme(
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  )

# Combine plots
(atlantic_overview <- atlantic +
    inset_element(subplot, left = 0.05, top = 0.5, right = 0.7, bottom = 0, align_to = "plot") +
    inset_element(atlantic_title, left = 0, top = 1, right = 1, bottom = 0.9))

ggsave("atlantic_overview_v0.3.jpg", plot = atlantic_overview, path = "../../Infinity/Coastal Water Quality - Documents/KYC 2025/", width = 210, height = 297, unit = "mm", dpi = 600)
```

```{r plot-false_bay, fig.width = 8.27, fig.height = 11.69, dpi = 600}
# Plot the data
(false_bay <- ggplot() +
  geom_sf(data = cct_coastline$osm_lines, colour = "white") +
  geom_sf(data = entire_coast_summary |> filter(coastline == "False Bay"), aes(colour = fct_rev(hazen_category)), size = 2) +
   labs(caption = "Data shown for reporting period (October 2023 to May 2025)") +
    
  # Add labels to some sites
  geom_text_repel(
      data = entire_coast_summary |> filter(coastline == "False Bay", site_id %in% c("XCS30", "XCS19", "XCS34")),
      aes(geometry = geom, label = site_description),
      stat = "sf_coordinates",
      size = unit(3, "mm"),
      xlim = c(18.4, 18.9),
      ylim = c(-34.4, -34.0),
      force = 150,
      hjust = 1,
      nudge_x = -0.01,
      nudge_y = -0.01,
      colour = "white",
      family = "Century Gothic"
      ) +
  geom_text_repel(
      data = entire_coast_summary |> filter(coastline == "False Bay", site_id %in% c("XCS15", "CS34", "CS11", "CS45", "CS03")),
      aes(geometry = geom, label = site_description),
      stat = "sf_coordinates",
      size = unit(3, "mm"),
      xlim = c(18.4, 18.9),
      ylim = c(-34.4, -34.0),
      force = 150,
      hjust = 0,
      nudge_x = 0.01,
      nudge_y = -0.01,
      colour = "white",
      family = "Century Gothic"
      ) +
   geom_text_repel(
      data = entire_coast_summary |> filter(coastline == "False Bay", site_id %in% c("CS37", "XCS32")),
      aes(geometry = geom, label = site_description),
      stat = "sf_coordinates",
      size = unit(3, "mm"),
      xlim = c(18.4, 18.9),
      ylim = c(-34.4, -34.0),
      force = 150,
      hjust = 0,
      nudge_x = 0.01,
      colour = "white",
      family = "Century Gothic"
      ) +
   geom_text_repel(
      data = entire_coast_summary |> filter(coastline == "False Bay", site_id %in% c("XCS09", "XCS08", "XCS29")),
      aes(geometry = geom, label = site_description),
      stat = "sf_coordinates",
      size = unit(3, "mm"),
      xlim = c(18.4, 18.9),
      ylim = c(-34.4, -34.0),
      force = 150,
      hjust = 1,
      nudge_x = -0.01,
      colour = "white",
      family = "Century Gothic"
      ) +
  coord_sf(xlim = c(18.44, 18.86), ylim = c(-34.42, -33.9)) +

  scale_colour_manual(name = "Water Quality Category", values = c("TFD" = "grey", "Poor" = "#D73027", "Sufficient" = "#FECC5C", "Good" = "#A6D96A", "Excellent" = "#3288BD")) +
  theme(
    plot.background = element_rect(fill = city_teal, colour = NA),
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "bottom",
    legend.title.position = "left",
    legend.direction = "horizontal",
    legend.title = element_text(hjust = 0.5),
    text = element_text(family = "Century Gothic", colour = "white"),
    legend.background = element_blank(),
    legend.box.just = "right"
        ) +
  guides(size = guide_legend(override.aes = list(colour = "white"))))

# Coastline title
false_bay_title <- ggplot() +
    geom_text(aes(x = 0, y = 1, label = "False Bay Coast"), hjust = 1, size = unit(12, "mm"), family = "Century Gothic", colour = "white", fontface = "bold") +
  
  # Styles
  theme(
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  )

# Combine plots
(false_bay_overview <- false_bay +
    inset_element(false_bay_title, left = 0, top = 1, right = 1.2, bottom = 0.9))

ggsave("false_bay_overview_v0.3.jpg", plot = false_bay_overview, path = "../../Infinity/Coastal Water Quality - Documents/KYC 2025/", width = 210, height = 297, unit = "mm", dpi = 600)
```

## Create a site comparison to show overview of sites at a glance

```{r site-comparison, fig.width = 8.27, fig.height = 11.69, dpi = 600}
# Have a look at the data
all_sites_summary <- entire_coast_summary |>
  mutate(samples_compliant_pct = 100 - samples_exceed_pct)

poorest_sites_summary <- all_sites_summary |> filter(samples_compliant_pct < 84)
  
# Plot the data
(compliance_plot <- ggplot(data = all_sites_summary, aes(x = samples_compliant_pct, fill = hazen_category)) +
  labs(x = "What % of samples at each site are compliant with the 240 cfu per 100 mL threshold?",
       caption = "Reporting period: October 2023 to May 2025") +
  geom_dotplot(
    method = "histodot",
    stackgroups = TRUE,
    colour = NA,
    dotsize = 0.7,
    stackratio = 1.2
  ) +
  geom_text(data = poorest_sites_summary,
                  aes(label = site_description, y = 0),
                  angle = 90,
                  family = "Century Gothic",
                  colour = "white",
                  nudge_y = 0.05,
                  vjust = 0.5,
                  hjust = 0
                  ) +
  scale_fill_manual(name = "Water Quality Category", values = c(
    "Poor" = "#D73027",
    "Sufficient" = "#FECC5C",
    "Good" = "#A6D96A",
    "Excellent" = "#3288BD"
    )) +
  theme(
    legend.position = "bottom",
    legend.background = element_blank(),
    plot.background = element_rect(fill = city_teal),
    panel.background = element_blank(),
    panel.grid = element_blank(),
    text = element_text(family = "Century Gothic", colour = "white"),
    axis.line.x = element_blank(),
    axis.ticks.x = element_line(colour = "white"),
    axis.text.x = element_text(colour = "white"),
    axis.title.x = element_text(vjust = -1),
    axis.text.y = element_blank(),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank()
    ) +
  coord_cartesian(xlim = c(40, 100)) +
  scale_x_continuous(breaks = seq(40, 100, 10)))

ggsave("compliance_plot.jpg", plot = compliance_plot, path = "../../Infinity/Coastal Water Quality - Documents/KYC 2025/", width = 8.27, height = 11.69, dpi = 600)
```


