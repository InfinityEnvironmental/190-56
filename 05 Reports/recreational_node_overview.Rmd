---
title: "Recreational Node Summary Page"
author: "Francois van Schalkwyk"
date: "`r Sys.Date()`"
output:
  bookdown::word_document2:
    reference_docx: recreational_node_overview_style_template.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r load-packages}
library(tidyverse)
library(dbplyr)
library(DBI)
library(pdftools)
library(readxl)
library(extrafont)
library(sf)
library(basemaps)
library(raster)
library(patchwork)
library(units)
library(osmdata)
library(ggrepel)
```

```{r db-connection}
# Connect to the Postgres database
# Enter credentials when prompted
con <- dbConnect(RPostgres::Postgres(),
  host = "aws-0-eu-central-1.pooler.supabase.com",
  port = 5432,
  user = str_c(rstudioapi::askForPassword(prompt = "Username: "), "wnrvdvesovnkmqbhkhjz", sep = "."),
  password = rstudioapi::askForPassword(),
  dbname = "postgres"
)
```

```{r prepare-city-colours}
city_blue <- "#0098c5"
city_green <- "#bacf00"
city_pink <- "#c8006f"
city_teal <- "#005870"
city_dark_green <- "#446414"
city_red <- "#9d2235"
city_brown <- "#47292e"
city_tan <- "#98871f"
```

# Create a map of all sites

```{r read-in-site-data}
sites_sf <- st_read(con, query = "SELECT * FROM coastal.sites", as_tibble = TRUE) |>
  st_cast("POINT") |>
  filter(active) |>
  arrange(site_description)
```

```{r}
# Read in coastline of Cape Town
cct <- st_read("../../Infinity/Infinity GIS - Server/base_data/sa/WC/cape_town/CPT Metropolitan/metropolitan municipality cpt.shp", as_tibble = TRUE) |>
  st_set_crs("EPSG: 4326")
```

```{r city-overview, fig.cap = "Map of coastal water quality monitoring sites in Cape Town", fig.width = 6.4, fig.height = 9.8, dpi = 600}
# Plot city of Cape Town with sites
cct_sites <- cct |>
  ggplot() +
  geom_sf(colour = NA, fill = "lightgrey") +
  geom_sf(data = sites_sf, aes(colour = category, size = category)) +
  theme(
    legend.position = "bottom",
    legend.background = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.background = element_blank(),
    panel.background = element_blank(),
    text = element_text(family = "Century Gothic"),
    legend.title = element_blank(),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    panel.grid = element_blank()
  ) +
  scale_colour_manual(values = c("Recreational Node" = city_green, "Coastal Monitoring Point" = "darkgrey")) +
  scale_size_manual(values = c("Recreational Node" = 1, "Coastal Monitoring Point" = 0.5))
```

# Create map of specific site

```{r create-bounding-box}
# Create bounding box for City of Cape Town area
sites_bbox <- st_bbox(obj = c(xmin = 18.25, xmax = 18.9, ymin = -34.40, ymax = -33.5))
st_bbox(sites_sf)
```

## Access Open Street Map data

```{r choose-site}
site_code <- "XCS04"
```

```{r create-bounding-box}
# Create a bounding box for one site
bbox <- sites_sf |>
  filter(site_id == site_code) |>
  st_bbox() + c(-0.015, -0.012, 0.015, 0.012)

# Transform bounding box to 102562
bbox_htb <- sites_sf |>
  filter(site_id == site_code) |>
  st_transform(crs = "ESRI: 102562") |>
  st_bbox() + c(-1500, -1500, 1500, 1500)
```

```{r}
# Access coastline data
coastline <- opq(bbox) |>
  add_osm_feature("natural", "coastline") |>
  osmdata_sf()

# Access beach data
beaches <- opq(bbox) |>
  add_osm_feature("natural", "beach") |>
  osmdata_sf()

# Access street data from OSM
streets <- opq(bbox) |>
  add_osm_feature(key = "highway") |>
  osmdata_sf()

# Access buildings data
buildings <- opq(bbox) |>
  add_osm_feature(key = "building") |>
  osmdata_sf()

# Access water
water <- opq(bbox) |>
   add_osm_feature("natural", "water") |>
   osmdata_sf()

# Add rivers
river <- opq(bbox) |>
   add_osm_feature("waterway", c("river", "stream")) |>
   osmdata_sf()
```

```{r access-streets, fig.width = 8.3, fig.height = 11.7, dpi = 600}
# Plot all data for a specific site
ggplot() +
  
  # Add beaches
  geom_sf(data = beaches$osm_polygons |> st_transform("ESRI: 102562"), fill = "lightyellow", colour = NA, alpha = 0.5) +
  
  # Add beaches that are multipolygons
  # geom_sf(data = beaches$osm_multipolygons |> st_transform("ESRI: 102562"), fill = "lightyellow", colour = NA, alpha = 0.5) +
  
  # Add rivers
  geom_sf(data = river$osm_lines |> st_transform("ESRI: 102562"), colour = "lightblue", alpha = 0.7) +
  
  # Add other water
  geom_sf(data = water$osm_polygons |> st_transform("ESRI: 102562"), fill = "lightblue", alpha = 0.7) +
  geom_sf(data = water$osm_multipolygons |> st_transform("ESRI: 102562"), fill = "lightblue", alpha = 0.7) +
  
  # Add the coastline
  geom_sf(data = coastline$osm_lines |> st_transform("ESRI: 102562"), colour = "lightgrey") +
  geom_sf(data = coastline$osm_polygons |> st_transform("ESRI: 102562"), colour = NA, fill = "grey", alpha = 0.5) +
  
  # Add streets
  geom_sf(data = streets$osm_lines |>
            st_transform("ESRI: 102562") |>
            filter(highway %in% c("motorway",
                                  "motorway_link",
                                  "trunk",
                                  "trunk_link",
                                  "primary",
                                  "primary_link",
                                  "secondary",
                                  "secondary_link",
                                  "tertiary",
                                  "tertiary_link",
                                  "unclassified",
                                  "residential",
                                  "service")), colour = "lightgrey") +
  # Add the monitoring sites with labels
  geom_sf(data = sites_sf |> st_transform("ESRI: 102562"), aes(colour = category)) +
  geom_sf_text(data = sites_sf, aes(label = site_description), hjust = 1, check_overlap = TRUE, nudge_x = -50, colour = "white") +
  
  # Add buildings
  geom_sf(data = buildings$osm_polygons |>
            st_transform("ESRI: 102562"), fill = "lightgrey", colour = NA, alpha = 0.5) +
  
  # Add the current monitoring point
  geom_sf(data = sites_sf |> filter(site_id == site_code) |> st_transform("ESRI: 102562"), colour = city_pink, size = 3) +
  
  scale_colour_manual(values = c("Recreational Node" = city_green, "Coastal Monitoring Point" = "grey")) +
  coord_sf(xlim = c(bbox_htb[1], bbox_htb[3]), ylim = c(bbox_htb[2], bbox_htb[4])) +
  
  theme(
    plot.background = element_rect(fill = city_teal),
    panel.background = element_blank(),
    legend.position = "none",
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank()
  )
```

# Create a figure that shows percentage of samples that have exceeded the threshold

```{r create-donut-plot}
# Create tibble
wheel <- tibble(percentage_exceedance = 37) |>
  ggplot(aes(x = "Site", y = percentage_exceedance, fill = percentage_exceedance)) +
  geom_col() + scale_fill_distiller(palette = "RdYlGn", direction = -1, limits = c(0, 50)) +
  coord_radial(theta = "y", start = 0, end = 2 * pi, inner.radius = 0.5, expand = FALSE) +
  scale_y_continuous(limits = c(0, 100)) +
  theme(
    plot.background = element_rect(fill = city_teal),
    legend.position = "none",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank()
  )

# Create the text
text <- tibble(percentage_exceedance = 37) |>
  ggplot() + 
  geom_text(aes(x = 0, y = 0, label = str_c(percentage_exceedance, "%", sep = "")), colour = "white", size = 15, size.unit = "mm", family = "Century Gothic") +
  theme(
    plot.background = element_blank(),
    legend.position = "none",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_blank()
  )

# Combine
wheel + inset_element(text, left = 0.35, bottom = 0.4, right = 0.65, top = 0.6, clip = FALSE)
```


```{r perc-exceedance-plot}
sites <- tbl(con, I("coastal.sites_view"))
results <- tbl(con, I("coastal.results_view"))
```

```{r perc-exceedance-plot}
# Join the tables
exceedances <- sites |>
  inner_join(results, by = "site_id") |>
  filter(site_id == site_code, between(sample_date, "2024-01-01", "2025-01-01"), monitoring_group %in% c("routine", "daily", "blue_flag")) |>
  collect() |>
  summarise(
    all_samples = n(),
    samples_exceed = sum(numeric_value > 240),
    samples_exceed_pct = round(sum(numeric_value > 240) / n() * 100, 0)
  ) |>
  mutate(
    label = str_c(samples_exceed, " out of ", all_samples, " samples taken exceeded the\nthreshold value for Enterococci\nof 240 cfu per 100 mL", sep = "")
    )
```

```{r exceedances-figure}
# Create a figure for the percentage exceedances
ggplot(data = exceedances) +
  geom_text(aes(x = 0, y = 0, label = label), family = "Century Gothic", size = 7, colour = "white", lineheight = 1) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    legend.position = "none",
    plot.background = element_rect(fill = city_teal)
  )
```

```{r create-donut-plot}
# Create tibble
wheel <- tibble(percentage_exceedance = 37) |>
  ggplot(aes(x = "Site", y = percentage_exceedance, fill = percentage_exceedance)) +
  geom_col() + scale_fill_distiller(palette = "RdYlGn", direction = -1, limits = c(0, 50)) +
  coord_radial(theta = "y", start = 0, end = 2 * pi, inner.radius = 0.5, expand = FALSE) +
  scale_y_continuous(limits = c(0, 100)) +
  theme(
    plot.background = element_rect(fill = city_teal),
    legend.position = "none",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank()
  )

# Create the text
text <- tibble(percentage_exceedance = 37) |>
  ggplot() + 
  geom_text(aes(x = 0, y = 0, label = str_c(percentage_exceedance, "%", sep = "")), colour = "white", size = 15, size.unit = "mm", family = "Century Gothic") +
  theme(
    plot.background = element_blank(),
    legend.position = "none",
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    panel.background = element_blank()
  )

# Combine
wheel + inset_element(text, left = 0.35, bottom = 0.4, right = 0.65, top = 0.6, clip = FALSE)
```

# Hazen Categories

```{r}
hazen <- sites |>
  inner_join(results, by = "site_id") |>
  filter(site_id == site_code, between(sample_date, "2024-01-01", "2025-01-01"), monitoring_group %in% c("routine", "daily", "blue_flag")) |>
  collect() |>
  summarise(
    min_date = min(sample_date),
    max_date = max(sample_date),
    n = sum(!is.na(numeric_value)),
    hazen95 = quantile(numeric_value, 0.95, type = 5, na.rm = TRUE),
    hazen90 = quantile(numeric_value, 0.9, type = 5, na.rm = TRUE),
  hazen_category = case_when(
      n < 10 ~ "Not enough samples",
      hazen95 <= 100 ~ "Excellent",
      hazen95 <= 200 ~ "Good",
      hazen95 > 200 & hazen90 > 185 ~ "Poor",
      hazen95 > 200 & hazen90 < 185 ~ "Sufficient"
  ))
```

```{r hazen-figure}
# Create a simple plot showing the category
(hazen_plot <- ggplot(data = hazen) +
  geom_text(aes(x = 1, y = 1, label = "The water quality\nduring the reporting period was", colour = hazen_category),
            family = "Century Gothic",
            size = 5,
            hjust = 0.5,
            colour = "white",
            lineheight = 1,
            vjust = -1.4) +
  geom_text(aes(x = 1, y = 1, label = hazen_category, colour = hazen_category),
            family = "Century Gothic",
            size = 15,
            hjust = 0.5,
            fontface = "bold",
            lineheight = 0.5,
            vjust = 0) +
  geom_text(aes(x = 1, y = 1, label = "according to the Hazen method"),
            family = "Century Gothic",
            size = 5,
            hjust = 0.5,
            lineheight = 1,
            colour = "white",
            vjust = 1.6) +
  theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    plot.background = element_blank()
  ) +
  scale_colour_manual(name = "Hazen Water Quality Category", values = c("Poor" = "#A50026", "Sufficient" = "#FDAE61", "Good" = "#A6D96A", "Excellent" = city_blue)))

RColorBrewer::display.brewer.all(type = "div")
RColorBrewer::brewer.pal(11, "RdYlGn")
```

Create a battery plot showing the Hazen calculation

```{r}
# Create a tibble with the four different levels
levels <- tibble(levels = c("Excellent", "Good", "Sufficient", "Poor")) |>
  mutate(levels = fct(levels, levels = c("Excellent", "Good", "Sufficient", "Poor")))

# Create a battery plot
ggplot(data = levels) +
  geom_tile(aes(y = fct_rev(levels), x = "Battery", fill = levels), height = 0.9, width = 0.5) +
  geom_tile(data = hazen, aes(y = hazen_category, x = "Battery"), colour = "white", fill = NA, linewidth = 2, height = 1, width = 0.52, linejoin = "round") +
  geom_text(aes(x = "Battery", y = fct_rev(levels), label = levels), colour = "white") +
  scale_fill_manual(name = "Hazen Water Quality Category", values = c("Poor" = "red", "Sufficient" = "yellow", "Good" = "orange", "Excellent" = "green")) +
  
# Style components
  theme(
    plot.background = element_blank(),
    panel.background = element_rect(fill = "navy"),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "none"
  )

RColorBrewer::display.brewer.all()
```

# Sample frequency plots

```{r}
# Plot sample frequency in the reporting period
samples_plot <- sites |>
  inner_join(results, by = "site_id") |>
  filter(between(sample_date, "2024-01-01", "2024-12-31"), monitoring_group %in% c("routine", "daily", "blue_flag")) |>
  collect() |>
  filter(site_id == site_code) |>
  group_by(month = floor_date(sample_date, "month"), site_id, monitoring_group) |>
  count() |>
  ungroup(monitoring_group) |>
  arrange(-n, .by_group = TRUE) |>
  mutate(monitoring_group = case_when(
    monitoring_group == "blue_flag" ~ "Blue Flag",
    monitoring_group == "routine" ~ "Routine",
    monitoring_group == "daily" ~ "Daily"
  )) |>
  
  # Plot the data
  ggplot() +
  labs(title = "Number of samples taken per month") +
  geom_segment(aes(x = month, xend = month, y = 0, yend = n, colour = monitoring_group), linewidth = 1) +
  geom_point(aes(x = month, y = n, colour = monitoring_group), position = position_dodge(preserve = "single"), size = 3) +
  
  # Scales
  scale_colour_manual(values = c("Routine" = city_green, "Daily" = city_pink, "Blue Flag" = city_blue)) +
  scale_y_continuous(breaks = scales::breaks_pretty()) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  
  coord_cartesian(xlim = c(ymd("2024-01-01"), ymd("2024-12-31"))) +
  
# Plot styling
  theme(
    legend.position = "bottom",
    panel.background = element_blank(),
    axis.title = element_blank(),
    legend.title = element_blank(),
    text = element_text(family = "Century Gothic"),
    plot.background = element_blank(),
    axis.text = element_text(colour = "white"),
    axis.ticks = element_line(colour = "white"),
    panel.grid = element_blank(),
    plot.title = element_text(colour = "white", hjust = 0.5, face = "bold"),
    legend.background = element_blank(),
    legend.text = element_text(colour = "white")
  )
```

```{r results-plot}
results_plot <- sites |>
  inner_join(results, by = "site_id") |>
  filter(between(sample_date, "2024-01-01", "2024-12-31"), monitoring_group %in% c("routine", "daily", "blue_flag")) |>
  collect() |>
  filter(site_id == site_code) |>
  ggplot(aes(x = sample_date, colour = monitoring_group)) +
  labs(y = "Enterococci\n(cfu per 100 mL)") +
  geom_segment(aes(xend = sample_date, y = 0, yend = numeric_value)) +
  geom_point(aes(y = numeric_value)) +
  geom_hline(yintercept = 240, colour = "white", size = 0.5, linetype = 2) +
  
  coord_cartesian(xlim = c(ymd("2024-01-01"), ymd("2024-12-31"))) +
  
  # Scales
  scale_colour_manual(values = c("routine" = city_green, "daily" = city_pink, "blue_flag" = city_blue)) +
  
  # Theme
  theme(
    plot.title = element_text(colour = "white", hjust = 0, face = "bold"),
    plot.background = element_blank(),
    legend.position = "none",
    legend.title = element_blank(),
    legend.background = element_blank(),
    legend.text = element_text(colour = "white"),
    text = element_text(family = "Century Gothic"),
    axis.title.y = element_text(colour = "white"),
    axis.title.x = element_blank(),
    axis.text = element_text(colour = "white"),
    axis.ticks = element_line(colour = "white"),
    panel.background = element_blank(),
    panel.grid = element_blank()
  )
```

```{r title-figure}
coast <- sites |>
  filter(site_id == site_code) |>
  mutate(coast_label = str_c(coastline, " Coast", sep = "")) |>
  ggplot() +
  geom_text(aes(x = 0, y = 1, label = coast_label), angle = 90, size.unit = "mm", size = 10, family = "Century Gothic", colour = "white", fontface = "bold") +
  
  # Styles
  theme(
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_blank()
  )
```

```{r site-name}
site_name <- sites |>
  filter(site_id == site_code) |>
  mutate(coast_label = str_c(coastline, " Coast", sep = "")) |>
  ggplot() +
  geom_text(aes(x = 0, y = 1, label = site_description), angle = 90, size.unit = "mm", size = 10, family = "Century Gothic", colour = "white") +
  
  # Styles
  theme(
    plot.background = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    axis.ticks = element_blank(),
    panel.background = element_rect(fill = city_blue)
  )
```

```{r base-plot}
base <- ggplot() +
  theme(
    plot.background = element_rect(fill = city_teal),
    panel.background = element_blank()
    )
```

```{r assemble-plot, fig.width = 8.27, fig.height = 11.69, dpi = 600}
(infographic <- base +
  inset_element(sites_overview, left = 0.6, bottom = 0.55, right = 1.1, top = 1.1, align_to = "plot") +
  inset_element(coast, left = 0, bottom = 0, right = 0.1, top = 0.5) +
  inset_element(site_name, left = 0, bottom = 0.5, right = 0.1, top = 1) +
  inset_element(site_map, left = 0.1, bottom = 0.8, right = 0.7, top = 1) +
  inset_element(results_plot, left = 0.15, bottom = 0.40, right = 0.95, top = 0.70) +
  inset_element(exceedance_plot, left = 0.15, bottom = 0.26, right = 1, top = 0.38) +
  inset_element(hazen_plot, left = 0.1, bottom = 0.6, right = 0.65, top = 0.83) +
  inset_element(samples_plot, left = 0.15, bottom = 0, right = 0.95, top = 0.25))

ggsave("camps_bay_south.jpg", plot = infographic, path = "02 Output Data/", width = 210, height = 297, units = "mm", dpi = 600)

sites_overview
site_map
site_name
coast
results_plot
samples_plot
hazen_plot
exceedance_plot
```