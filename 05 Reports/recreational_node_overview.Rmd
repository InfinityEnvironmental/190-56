---
title: "Recreational Node Summary Page"
author: "Francois van Schalkwyk"
date: "`r Sys.Date()`"
output:
  bookdown::word_document2:
    reference_docx: recreational_node_overview_style_template.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r load-packages}
library(tidyverse)
library(dbplyr)
library(DBI)
library(pdftools)
library(readxl)
library(extrafont)
library(sf)
library(basemaps)
library(raster)
library(patchwork)
library(units)
library(osmdata)
```

```{r db-connection}
# Connect to the Postgres database
# Enter credentials when prompted
con <- dbConnect(RPostgres::Postgres(),
  host = "aws-0-eu-central-1.pooler.supabase.com",
  port = 5432,
  user = str_c(rstudioapi::askForPassword(prompt = "Username: "), "wnrvdvesovnkmqbhkhjz", sep = "."),
  password = rstudioapi::askForPassword(),
  dbname = "postgres"
)
```

```{r prepare-city-colours}
city_blue <- "#0098c5"
city_green <- "#bacf00"
city_pink <- "#c8006f"
city_teal <- "#005870"
city_dark_green <- "#446414"
city_red <- "#9d2235"
city_brown <- "#47292e"
city_tan <- "#98871f"
```

# Create a map of all sites

```{r read-in-site-data}
sites <- st_read(con, query = "SELECT * FROM coastal.sites", as_tibble = TRUE) |>
  st_cast("POINT") |>
  filter(active) |>
  arrange(site_description)
```

```{r city-overview, fig.cap = "Map of coastal water quality monitoring sites in Cape Town", fig.width = 6.4, fig.height = 9.8, dpi = 600}
cct <- st_read("../../Infinity/Infinity GIS - Server/base_data/sa/WC/cape_town/CPT Metropolitan/metropolitan municipality cpt.shp", as_tibble = TRUE) |>
  st_set_crs("EPSG: 4326")

-- temporary

cct <- st_read("../../Downloads/OneDrive_1_2025-04-22/metropolitan municipality cpt.shp", as_tibble = TRUE) |>
  st_set_crs("EPSG: 4326")

-- 

cct_sites <- cct |>
  ggplot() +
  labs(
    title = "Coastal Water Quality Monitoring Stations",
    subtitle = "City of Cape Town"
  ) +
  geom_sf(colour = NA) +
  geom_sf(data = sites, aes(colour = category, size = category)) +
  theme(
    legend.position = "bottom",
    legend.background = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank(),
    plot.background = element_blank(),
    panel.background = element_blank(),
    text = element_text(family = "Century Gothic"),
    legend.title = element_blank(),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5),
    panel.grid = element_blank()
  ) +
  scale_colour_manual(values = c("Recreational Node" = city_green, "Coastal Monitoring Point" = "darkgrey")) +
  scale_size_manual(values = c("Recreational Node" = 1, "Coastal Monitoring Point" = 0.5))

ggsave("coastal_water_quality_sites.jpg", plot = cct_sites, path = "02 Output Data/", width = 5, height = 6.7, dpi = 600)
```

# Create map of specific site

```{r plot-zoomed-data, fig.width = 6.4, fig.height = 9.8, dpi = 600}
# Select site_id
site <- "XCS34"

# Choose a specific site to plot
sites_overview <- cct_sites +
  geom_sf(data = sites |> filter(site_id == site), colour = city_pink, size = 5, shape = 16, alpha = 0.5) +
  theme(
    plot.title = element_blank(),
    plot.subtitle = element_blank()
  )
```

```{r build-basemap, fig.height = 6, fig.width=6, dpi = 600}
# Have a look at the types of basemaps
basemaps::get_maptypes()
set_defaults(map_service = "esri", map_type = "world_hillshade")
imagery <- sites |>
  filter(site_id == site) |>
  st_buffer(1500) |>
  basemap()

# Set the extent for each site
circle <- sites |>
  filter(site_id == site) |>
  st_buffer(1500) |>
  st_simplify(dTolerance = 25)

# Get OpenStreetMap for the circle
cropped_streets <- circle |>
  st_bbox() |>
  opq(timeout = 50) |>
  add_osm_feature(key = "highway", value = c("motorway", "primary", "secondary", "tertiary", "residential", "unclassified")) |>
  osmdata_sf()

# Get beaches from OSM
cropped_beach <- circle |>
  st_bbox() |>
  opq(timeout = 50) |>
  add_osm_feature(key = "natural", value = c(
    "beach",
    "bay",
    "coastline",
    "dune",
    "sand"
    )) |>
  osmdata_sf()

available_features()
available_tags("water")
available_tags("natural")

# Crop the cct basemap with the circle
cropped_basemap <- st_intersection(cct, circle)

# Crop the water
#cropped_water_lines <- st_intersection(cropped_water$osm_lines, circle)
# cropped_water_polygons <- st_intersection(cropped_water$osm_polygons, circle)

# Crop the streets
cropped_streets <- st_intersection(cropped_streets$osm_lines, circle)

# Plot the data
site_map <- ggplot() +
  geom_sf(data = circle, colour = NA, fill = "lightblue", size = 2) +
  geom_sf(data = cropped_basemap, colour = NA) +
  geom_sf(data = cropped_streets, colour = "white") +
  #geom_sf(data = cropped_beach$osm_multipolygons, colour = NA, fill = "lightyellow") +
  #geom_sf(data = cropped_water_lines, colour = "lightblue") +
  #geom_sf(data = cropped_water_polygons, colour = "lightblue", fill = "lightblue") +
  geom_sf(data = circle, colour = "grey", fill = NA, size = 5) +
  geom_sf(data = sites |> filter(site_id == site) |> st_transform("EPSG: 3857") |> st_buffer(50), fill = city_pink, colour = NA, alpha = 0.5, size = 2) +
  theme(
    panel.background = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    plot.background = element_blank(),
    panel.grid = element_blank()
  )
```

# Inset the site map onto the overview map

```{r inset-map, fig.width = 6, fig.height = 6, dpi = 600}
sites_overview + inset_element(site_map, left = 0.4, right = 1, bottom = 0.4, top = 1) & theme(plot.background = element_rect(fill = city_teal))
sites_overview + site_map
```

# Create a figure percentage of samples that have exceeded the threshold

```{r perc-exceedance-plot}
sites <- tbl(con, I("coastal.sites_view"))
results <- tbl(con, I("coastal.results_view"))

# Choose the site
site <- "CN11"

# Join the tables
exceedances <- sites |>
  inner_join(results, by = "site_id") |>
  filter(site_id == "CN22", between(sample_date, "2024-01-01", "2025-01-01"), monitoring_group %in% c("routine", "daily")) |>
  collect() |>
  summarise(
    all_samples = n(),
    samples_exceed = sum(numeric_value > 240),
    samples_exceed_pct = round(sum(numeric_value > 240) / n() * 100, 0)
  ) |>
  mutate(
    label = str_c("of ", all_samples, " samples taken\nexceeded\nthe threshold\nvalue for\nEnterococci\nof 240 cfu per 100 mL", sep = "")
    )

ggplot(data = exceedances) +
  geom_text(aes(x = 2, y = 1, label = label), family = "Century Gothic", size = 10, colour = "white", hjust = 1) +
  geom_text(aes(x = 1, y = 1, label = str_c(samples_exceed_pct, "%", sep = "")), family = "Century Gothic", colour = "white", size = 50, hjust = 0) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    panel.background = element_rect(fill = city_teal),
    panel.grid = element_blank()
  )
```

# Hazen Categories

```{r}
sites |>
  inner_join(results, by = "site_id") |>
  filter(site_id == "CN22", between(sample_date, "2024-01-01", "2025-01-01"), monitoring_group %in% c("routine", "daily")) |>
  collect() |>
  summarise(
    min_date = min(sample_date),
    max_date = max(sample_date),
    n = sum(!is.na(numeric_value)),
    hazen95 = quantile(numeric_value, 0.95, type = 5, na.rm = TRUE),
    hazen90 = quantile(numeric_value, 0.9, type = 5, na.rm = TRUE),
  hazen_category = case_when(
      n < 10 ~ "Not enough samples",
      hazen95 <= 100 ~ "Excellent",
      hazen95 <= 200 ~ "Good",
      hazen95 > 200 & hazen90 > 185 ~ "Poor",
      hazen95 > 200 & hazen90 < 185 ~ "Sufficient"
  )) |>
  
  # Create a simple plot showing the category
  ggplot() +
  geom_rect(aes(xmin = 0.995, xmax = 1.005, ymin = 0.995, ymax = 1.005, fill = hazen_category)) +
  geom_text(aes(x = 1, y = 1, label = hazen_category), family = "Century Gothic", size = 35, hjust = 0.5, colour = "white") +
  theme(
    legend.position = "none",
    panel.background = element_blank(),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  ) +
  scale_fill_manual(name = "Hazen Water Quality Category", values = c("Poor" = "red", "Sufficient" = "orange", "Good" = "green", "Excellent" = "darkblue"))
```

