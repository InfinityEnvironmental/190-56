---
title: "Overview of Data Sources for Coastal Water Quality"
author: "Francois van Schalkwyk"
date: "`r Sys.Date()`"
output:
  bookdown::word_document2:
    reference_docx: "data_source_overview_style_template.docx"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  include = FALSE,
  dpi = 600
  )
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r load-packages}
library(tidyverse)
library(dbplyr)
library(DBI)
library(pdftools)
library(readxl)
library(extrafont)
```

```{r db-connection}
# Connect to the Postgres database
con <- dbConnect(RPostgres::Postgres(),
  host = "infinity.cdmqm0mu0qf8.eu-north-1.rds.amazonaws.com",
  port = 5432,
  user = rstudioapi::askForPassword(prompt = "Username: "),
  password = rstudioapi::askForPassword(),
  dbname = "infinity"
)
```

```{r load-data}
cct <- read_csv("02 Output Data/01 CSV/faecal_streptococci_data_clean.csv") |>
  mutate(dataset = 'cct') |>
  rename(sample_date = date)
sabs <- read_csv("02 Output Data/01 CSV/sabs_data_clean.csv") |>
  mutate(dataset = 'sabs')
lims <- read_csv("02 Output Data/01 CSV/lims_data_clean.csv") |>
  mutate(dataset = 'lims')
walab <- tbl(con, I("coastal.results")) |> collect() |>
  mutate(dataset = "walab")
```

# Sample Frequency

## Coastal Management Branch Excel Spreadsheets

```{r plot-frequency, fig.cap = "Number of samples received per month from data received from Coastal Management Branch", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
cct |>
  mutate(year = year(sample_date), month = month(sample_date, label = TRUE)) |>
  group_by(year, month) |>
  count() |>
  ggplot(aes(x = month, y = n)) +
  labs(x = "Month", y = "Number of samples") +
  geom_col(position = position_dodge(preserve = "single")) +
  facet_wrap(facets = vars(year)) +
  theme(
    text = element_text(family = "Century Gothic"),
    axis.text.x = element_text(angle = 90)
  )
```

```{r plot-received-with-source, fig.cap = "Number of samples received per month from data received from Coastal Management Branch", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
cct |>
  mutate(year = year(sample_date), month = month(sample_date, label = TRUE)) |>
  group_by(year, month, source) |>
  count() |>
  ggplot(aes(x = month, y = n, fill = source)) +
  labs(x = "Month", y = "Number of samples") +
  geom_col() +
  facet_wrap(facets = vars(year)) +
  theme(
    text = element_text(family = "Century Gothic"),
    axis.text.x = element_text(angle = 90)
  )
```

Key points to note:

1. The data labelled "CMB" are data that are present in the combined spreadsheets but not in the original Excel spreadsheets
2. Majority of the data that was added to the spreadsheets are from Sep 2023 through Jan 2025

## Data received from LIMS dataset

```{r plot-lims-data, fig.cap = "Number of samples received per month from 2005 to 2024 according to the LIMS dataset", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
lims |>
  mutate(year = year(sample_date), month = month(sample_date, label = TRUE)) |>
  group_by(year, month) |>
  count() |>
  ggplot(aes(x = month, y = n)) +
  labs(x = "Month", y = "Number of samples") +
  geom_col() +
  facet_wrap(facets = vars(year)) +
  theme(
    text = element_text(family = "Century Gothic"),
    axis.text.x = element_text(angle = 90)
  )
```

```{r calculate-frequency}
median_frequency <- lims |>
  group_by(site_id) |>
  arrange(sample_date, .by_group = TRUE) |>
  mutate(time_since_previous_sample = sample_date - lag(sample_date)) |>
  summarise(median_frequency = median(time_since_previous_sample, na.rm = TRUE)) |>
  summarise(median_frequency = median(median_frequency, na.rm = TRUE)) |>
  pull()
```

The average frequency of the samples for every site in the LIMS dataset is roughly two weeks (median = `r median_frequency`).

## Overlap between CMB and LIMS datasets

```{r frequency-overlap-cct-lims}
cct_lims_both <- dplyr::intersect(
  cct |> select(sample_date, site_id, censored_value, numeric_value),
  lims |> select(sample_date, site_id, censored_value, numeric_value)
) |>
  mutate(subset = "CMB & LIMS")

cct_only <- dplyr::setdiff(
  cct |> select(sample_date, site_id, censored_value, numeric_value),
  lims |> select(sample_date, site_id, censored_value, numeric_value)
) |>
  mutate(subset = "CMB")

lims_only <- dplyr::setdiff(
  lims |> select(sample_date, site_id, censored_value, numeric_value),
  cct |> select(sample_date, site_id, censored_value, numeric_value)
) |>
  mutate(subset = "LIMS")

cct_lims <- bind_rows(
  cct_lims_both,
  cct_only,
  lims_only
)
```

```{r plot-cct-lims-overlap, fig.cap = "Overlap of data between CMB and LIMS datasets", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
cct_lims |>
  mutate(
    year = year(sample_date),
    month = month(sample_date, label = TRUE)
  ) |>
  group_by(year, month, subset) |>
  count() |>
  ggplot(aes(x = month, y = n, fill = subset)) +
  geom_col() +
  labs(x = "Date",
    y = "Number of samples",
    fill = "Subset of data"
  ) +
  facet_wrap(facets = vars(year)) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90),
    text = element_text(family = "Century Gothic")
  )
```

Key points to note:

1. There are data in the LIMS dataset that are not in the CMB spreadsheets throughout the range of the data
2. There is also a small amount of data in the Excel spreadsheets that are not in the LIMS data, and this increases from 2023 onwards as the SABS data were populated into the Excel spreadsheets
3. There are more sites in the LIMS data than in the CMB spreadsheets, accounting for the higher number of samples per month

## Overlap between LIMS data and SABS data

```{r frequency-overlap-sabs-lims}
sabs_lims_both <- dplyr::intersect(
  sabs |> select(sample_date, site_id, censored_value, numeric_value),
  lims |> select(sample_date, site_id, censored_value, numeric_value)
) |>
  mutate(subset = "SABS & LIMS")

sabs_only <- dplyr::setdiff(
  sabs |> select(sample_date, site_id, censored_value, numeric_value),
  lims |> select(sample_date, site_id, censored_value, numeric_value)
) |>
  mutate(subset = "SABS")

lims_only <- dplyr::setdiff(
  lims |> select(sample_date, site_id, censored_value, numeric_value),
  sabs |> select(sample_date, site_id, censored_value, numeric_value)
) |>
  mutate(subset = "LIMS")

sabs_lims <- bind_rows(
  sabs_lims_both,
  sabs_only,
  lims_only
)
```

```{r plot-sabs-lims-overlap, fig.cap = "Overlap of data between CMB and LIMS datasets", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
sabs_lims |>
  mutate(
    year = year(sample_date),
    month = month(sample_date, label = TRUE)
  ) |>
  group_by(year, month, subset) |>
  count() |>
  ggplot(aes(x = month, y = n, fill = subset)) +
  geom_col() +
  labs(x = "Date",
    y = "Number of samples",
    fill = "Subset of data"
  ) +
  facet_wrap(facets = vars(year)) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90),
    text = element_text(family = "Century Gothic")
  )
```

Key points to note:

1. There is no overlap in data between the SABS data from 2024 and 2025, and the LIMS data
2. The LIMS data in 2024 and 2025 are therefore completely made up of SSB data, and the results are typical of Enterolert data
3. This makes it highly likely that these data come from Enterolert results from within the SSB

## Overlap between SABS and CMB data

```{r frequency-overlap-sabs-cmb}
cmb <- cct |>
  filter(source == "CMB")

sabs_cmb_both <- dplyr::intersect(
  sabs |> select(sample_date, site_id, censored_value, numeric_value),
  cmb |> select(sample_date, site_id, censored_value, numeric_value)
) |>
  mutate(subset = "SABS & CMB")

sabs_only <- dplyr::setdiff(
  sabs |> select(sample_date, site_id, censored_value, numeric_value),
  cmb |> select(sample_date, site_id, censored_value, numeric_value)
) |>
  mutate(subset = "SABS")

cmb_only <- dplyr::setdiff(
  cmb |> select(sample_date, site_id, censored_value, numeric_value),
  sabs |> select(sample_date, site_id, censored_value, numeric_value)
) |>
  mutate(subset = "CMB")

sabs_cmb <- bind_rows(
  sabs_cmb_both,
  sabs_only,
  cmb_only
)
```

```{r plot-sabs-cmb-overlap, fig.cap = "Overlap of data between CMB and SABS datasets", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
sabs_cmb |>
  mutate(
    year = year(sample_date),
    month = month(sample_date, label = TRUE)
  ) |>
  group_by(year, month, subset) |>
  count() |>
  ggplot(aes(x = month, y = n, fill = subset)) +
  geom_col() +
  labs(x = "Date",
    y = "Number of samples",
    fill = "Subset of data"
  ) +
  facet_wrap(facets = vars(year)) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 90),
    text = element_text(family = "Century Gothic")
  )
```
Key points to note:

1. There is much less overlap in the CMB data and the SABS data than expected.
2. This is primarily because many of the dates of the SABS data were incorrectly entered into the spreadsheets, and the records therefore appear to be different results, when they are in fact the same. We should be able to confirm this by comparing the daily distribution of SABS data and CMB data during this period.
3. We would expect that most of the data added to the spreadsheets would have been from SABS, and the few that were not from SABS would be from Blue Flag.

```{r sabs-cmb-dates, fig.cap = "Dates of SABS and CMB data", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
sabs_cmb |>
  mutate(sample_date = date(sample_date)) |>
  group_by(sample_date, subset) |>
  summarise(count = n()) |>
  ggplot(aes(x = sample_date, y = count, fill = subset)) +
  geom_col(position = position_dodge(preserve = "single")) +
  labs(x = "Date", y = "Number of samples", fill = "Subset of data") +
  theme(legend.position = "bottom",
        text = element_text(family = "Century Gothic")) +
  coord_cartesian(xlim = c(ymd("2023-10-01"), ymd("2023-11-01"))) +
  scale_x_date(minor_breaks = "1 day")
```

Key points to note:

1. The red bars show data that are in the CMB spreadsheets but not in the SABS data
2. The green bars show data that are in the SABS data but not in the CMB spreadsheets
3. The blue bars show data that are both in the SABS data and in the CMB spreadsheets
4. Note that there are always data on the first sampling date of the week in the Excel spreadsheets that are not in the SABS data
5. Note that there are always data on the second and third sampling days of the week that are not in the spreadsheets

## All data sources shown together

```{r plot-all-data}
cct_counts <- cct |>
  mutate(year = year(sample_date), month = month(sample_date, label = TRUE)) |>
  group_by(year, month) |>
  count() |>
  mutate(dataset = "CMB")

cmb_counts <- cmb |>
  mutate(year = year(sample_date), month = month(sample_date, label = TRUE)) |>
  group_by(year, month) |>
  count() |>
  mutate(dataset = "cmb")

sabs_counts <- sabs |>
  mutate(year = year(sample_date), month = month(sample_date, label = TRUE)) |>
  group_by(year, month) |>
  count() |>
  mutate(dataset = "SABS")

walab_counts <- walab |>
  mutate(year = year(sample_date), month = month(sample_date, label = TRUE)) |>
  group_by(year, month) |>
  count() |>
  mutate(dataset = "WALAB")

all_counts <- bind_rows(cct_counts, cmb_counts, sabs_counts, walab_counts)
```

### All data sources from 2005 to 2025

```{r plot-all-counts, fig.cap = "Number of samples per month for all datasets", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
all_counts |>
  ggplot(aes(x = month, y = n, fill = dataset)) +
  labs(
    x = "Month",
    y = "Number of samples"
  ) +
  geom_col(position = position_dodge(preserve = "single")) +
  facet_grid(rows = vars(year)) +
  theme(
    legend.position = "bottom",
    text = element_text(family = "Century Gothic"),
    axis.text.x = element_text(angle = 90)
  ) +
  scale_fill_brewer(name = "Dataset", type = "qual", palette = 3)
```

Key points to note:

1. There is consistently more data in the LIMS dataset than in the Excel spreadsheets - this is almost exclusively due to the fact that there are more sites sampled in the LIMS dataset than in the CMB spreadsheets

### All data sources from 2020 to 2025

```{r plot-all-counts-subset, fig.cap = "Number of samples per month for all datasets, for the last five years", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
all_counts |>
  filter(year >= 2020) |>
  ggplot(aes(x = month, y = n, fill = dataset)) +
  labs(
    x = "Month",
    y = "Number of samples"
  ) +
  geom_col(position = position_dodge(preserve = "single")) +
  facet_grid(rows = vars(year)) +
  theme(
    legend.position = "bottom",
    text = element_text(family = "Century Gothic"),
    axis.text.x = element_text(angle = 90)
  ) +
  scale_fill_brewer(name = "Dataset", type = "qual", palette = 3)
```

Key points to note:

1. Note the sparsity of the data in 2022 and 2023, with the AL Abbot data situated in the middle of this period
2. There are differences between CMB spreadsheets and SABS data in 2023 and 2025
3. There are differences between CMB spreadsheets and WALAB data in 2024 and 2025

# Results

```{r combine-data}
cct_results <- cct |>
  select(sample_date, site_id, censored_value, numeric_value, dataset)

lims_results <- lims |>
  select(sample_date, site_id, censored_value, numeric_value, dataset)

sabs_results <- sabs |>
  select(sample_date, site_id, censored_value, numeric_value, dataset)

walab_results <- walab |>
  mutate(numeric_value = case_when(
    str_detect(enterococci_cfu_per_100ml, "<") ~ str_remove(enterococci_cfu_per_100ml, "<") |> as.numeric() / 3,
    str_detect(enterococci_cfu_per_100ml, ">") ~ str_remove(enterococci_cfu_per_100ml, ">") |> as.numeric() * 3,
    str_detect(enterococci_cfu_per_100ml, "ND") ~ 0,
    .default = as.numeric(enterococci_cfu_per_100ml |> str_remove("\\s"))
  )) |>
  rename(censored_value = enterococci_cfu_per_100ml) |>
  select(sample_date, site_id, censored_value, numeric_value, dataset)

all_results <- bind_rows(
  cct_results,
  lims_results,
  sabs_results,
  walab_results
) |>
  mutate(sample_date = date(sample_date))
```

## Results for all datasets

```{r plot-all-results, fig.cap = "Results for all datasets", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
all_results |>
  mutate(dataset = str_to_upper(dataset),
         sample_date = date(sample_date)) |>
  ggplot(aes(x = sample_date, y = numeric_value, colour = dataset)) +
  geom_point() +
  labs(
    x = "Date",
    y = "Enterococci (cfu per 100 mL)"
  ) +
  theme(
    legend.position = "bottom",
    text = element_text(family = "Century Gothic")
  ) +
  scale_colour_brewer(name = "Dataset", type = "qual", palette = 3) +
  scale_x_date(minor_breaks = "1 year")
```

Key points to note:

1. The horizontal streak from 2005 to 2022 is a typical exceedance of 5000 cfu per 100 mL (multiplied by 3 for the Hazen method). This is typical of the SSB membrane filtration method
2. The outliers in 2024 near the 75000 cfu per 100 mL line are exceedances of >24196 cfu per 100 mL typical of the Enterolert method, which was used by Scientific Services during this period

## Outlier data in August 2024 from LIMS data using Enterolert

```{r investigate-streak, fig.cap = "Outlier data in August 2024 from the LIMS data set", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
all_results |>
  filter(dataset == "lims") |>
  group_by(sample_date, numeric_value) |>
  mutate(count = n()) |>
  ggplot(aes(x = sample_date, y = numeric_value, size = count, label = count)) +
  labs(x = "Date",
       y = "Enterococci (cfu per 100 mL)",
       size = "Frequency observed") +
  geom_point() +
  theme(
    legend.position = "bottom",
    text = element_text(family = "Century Gothic")
  ) +
  scale_x_date(breaks = "1 month", date_labels = "%B") +
  coord_cartesian(xlim = c(ymd("2024-06-01"), ymd("2024-12-01")))
```

```{r detect-sites, include = TRUE, echo = FALSE}
lims |>
  filter(sample_date == "2024-08-21", numeric_value > 70000) |>
  select(sample_date, site_id, censored_value, numeric_value) |>
  rename(
    "Sample Date" = sample_date,
    "Site ID" = site_id,
    "Censored Value (cfu per 100 mL)" = censored_value,
    "Numeric Value (cfu per 100 mL)" = numeric_value
  ) |>
  knitr::kable(caption = "Very high values according to LIMS dataset on 21 August 2024")
```

```{r plot-all-results-year, fig.cap = "Results for all datasets excluding outlier values", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
all_results |>
  mutate(dataset = str_to_upper(dataset),
         sample_date = date(sample_date)) |>
  ggplot(aes(x = sample_date, y = numeric_value, colour = dataset)) +
  geom_point() +
  labs(
    x = "Date",
    y = "Enterococci (cfu per 100 mL)"
  ) +
  theme(
    legend.position = "bottom",
    text = element_text(family = "Century Gothic")
  ) +
  scale_colour_brewer(name = "Dataset", type = "qual", palette = 3) +
  scale_x_date(minor_breaks = "1 year") +
  scale_y_continuous(breaks = seq(0, 10000, 1000)) +
  coord_cartesian(ylim = c(0, 10000))
```

```{r plot-all-results-2020, fig.cap = "Results for all datasets from 2020 to 2025", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
all_results |>
  mutate(dataset = str_to_upper(dataset),
         sample_date = date(sample_date)) |>
  ggplot(aes(x = sample_date, y = numeric_value, colour = dataset)) +
  geom_point() +
  facet_grid(rows = vars(dataset)) +
  labs(
    x = "Date",
    y = "Enterococci (cfu per 100 mL)"
  ) +
  theme(
    legend.position = "bottom",
    text = element_text(family = "Century Gothic")
  ) +
  scale_colour_brewer(name = "Dataset", type = "qual", palette = 3) +
  scale_x_date(minor_breaks = "1 year") +
  scale_y_continuous(breaks = seq(0, 10000, 1000)) +
  coord_cartesian(ylim = c(0, 10000), xlim = c(ymd("2020-01-01"), ymd("2025-04-01")))
```

```{r zoom-al-abbot, fig.cap = "Results for AL Abbot data between 2022 and 2023", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
all_results |>
  mutate(dataset = str_to_upper(dataset)) |>
  filter(between(sample_date, ymd("2022-10-01"), ymd("2023-06-01"))) |>
  ggplot(aes(x = sample_date, y = numeric_value, colour = dataset)) +
  geom_point() +
  labs(
    x = "Date",
    y = "Enterococci (cfu per 100 mL)"
  ) +
  theme(
    legend.position = "bottom",
    text = element_text(family = "Century Gothic")
  ) +
  scale_colour_brewer(name = "Dataset", type = "qual", palette = 3)
  
```

# Sites

```{r sites-differences}
cct_sites <- cct |>
  distinct(site_id) |>
  arrange(site_id)

sabs_sites <- sabs |>
  distinct(site_id) |>
  arrange(site_id)

lims_sites <- lims |>
  distinct(site_id) |>
  arrange(site_id)

walab_sites <- walab |>
  distinct(site_id) |>
  arrange(site_id)
```

```{r sites-discrepancies}
# CCT and SABS
dplyr::setdiff(cct_sites, sabs_sites) # 52 sites
dplyr::setdiff(sabs_sites, cct_sites) # 11 sites

# CCT and WALAB
dplyr::setdiff(cct_sites, walab_sites) # 2 sites
dplyr::setdiff(walab_sites, cct_sites) # 33 sites

# SABS and LIMS
dplyr::setdiff(sabs_sites, lims_sites) # 11 sites
dplyr::setdiff(lims_sites, sabs_sites) # 79 sites

# LIMS and WALAB
dplyr::setdiff(lims_sites, walab_sites) # 19 sites
dplyr::setdiff(walab_sites, lims_sites) # 23 sites

# CCT and LIMS
dplyr::setdiff(lims_sites, cct_sites) # 44 sites
dplyr::setdiff(cct_sites, lims_sites) # 17 sites

# SABS and WALAB
dplyr::setdiff(sabs_sites, walab_sites) # 7 sites
dplyr::setdiff(walab_sites, sabs_sites) # 79 sites
```


```{r sites-overlap-plot-setup, fig.cap = "Overlap of sites between datasets", fig.width = 7, fig.height = 9}
# Create a matrix of site overlaps
sites_overlap_wider <- dplyr::union(cct_sites, sabs_sites) |>
  dplyr::union(lims_sites) |>
  dplyr::union(walab_sites) |>
  arrange(site_id) |>
  mutate(
    cct = site_id %in% pull(cct_sites),
    sabs = site_id %in% pull(sabs_sites),
    lims = site_id %in% pull(lims_sites),
    walab = site_id %in% pull(walab_sites)
    ) |>
  arrange(-cct, -lims, -sabs, -walab)

# Create plot function
plot_site_overlap <- function(data){
data |>
    mutate(site_id = fct_inorder(site_id)) |>
    pivot_longer(cols = cct:walab, names_to = "dataset", values_to = "present") |>
    mutate(
      dataset = str_to_upper(dataset)
      ) |>
    ggplot(aes(x = .data$dataset, y = .data$site_id, fill = .data$present)) +
      geom_tile() +
      labs(x = "Dataset", y = "Site ID", fill = "Sites Present in Dataset") +
      theme(
        legend.position = "bottom",
        text = element_text(family = "Century Gothic")
      )
}

plot_site_overlap(sites_overlap_wider)
```

```{r in-cct, fig.cap = "Sites that are present in CCT dataset", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
sites_overlap_wider |>
  filter(cct) |>
  plot_site_overlap()
```

```{r in-sabs, fig.cap = "Sites that are present in SABS dataset", fig.width = 7, fig.height = 9, include = TRUE, echo = FALSE}
sites_overlap_wider |>
  filter(sabs) |>
  plot_site_overlap()
```

```{r in-lims, fig.cap = "Sites that are present in LIMS dataset", fig.width = 7, fig.height = 10, include = TRUE, echo = FALSE}
sites_overlap_wider |>
  filter(lims) |>
  plot_site_overlap()
```

```{r in-walab, fig.cap = "Sites that are present in WALAB dataset", fig.width = 7, fig.height = 10, include = TRUE, echo = FALSE}
sites_overlap_wider |>
  filter(walab) |>
  plot_site_overlap()
```
